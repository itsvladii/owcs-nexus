---
export const prerender = false;

//--- IMPORT DI TUTTO IL NECESSARIO ---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection, getEntry } from "astro:content";
import { generateTeamQuiz } from "../../lib/quizGenerator";
import Quiz from "../../components/Quiz.tsx";

//--- RICAVO TUTTE LE SQUADRE REGISTRATE ---
const { slug } = Astro.params;
const teamEntry = await getEntry("teams", slug);

//se team non trovato, riporta un errore
if (!teamEntry) {
  return new Response(null, { status: 404, statusText: "Not Found" });
}

//--- RICAVO TUTTI I GIOCATORI REGISTRATI ---
const allPlayers = await getCollection("players");
const { Content } = await teamEntry.render();
const roster = allPlayers.filter((player) => player.data.team === teamEntry.slug);
const allTeams = await getCollection('teams');

//--- RICAVO TUTTI GLI ASSET (PNG ED IMG) NECESSARI ---
const logoUrl = teamEntry.data.logo.replace(
  "/upload/",
  "/upload/w_200,h_200,c_pad,f_auto,q_auto/",
);
const cloudinaryBaseUrl = teamEntry.data.logo.split("/upload/")[0] + "/upload";
const regionSlug = teamEntry.data.region.toLowerCase();
const namecardFilename = `owcs_${regionSlug}.png`;
const namecardUrl = `${cloudinaryBaseUrl}/f_auto,q_auto,w_1024/${namecardFilename}`;

//--- GENERAZIONE DEI QUIZ DEI TEAM ---
//creo le domande, basandosi sulle informazioni del team
const teamQuizQuestions = generateTeamQuiz(teamEntry, roster, allPlayers, allTeams);
const teamPhotoUrl = teamEntry.data.banner
  ? teamEntry.data.banner.replace('/upload/', '/upload/f_auto,q_auto:best,e_sharpen/')
  : null;

/* --- parametri per l'API (non usato, da rivedere l'utilizzo)
const apiKey = import.meta.env.LIQUIPEDIA_API_KEY;
const teamName = teamEntry.data.name;
const myUserAgent = 'OWCS-Wiki (barcanvladi@gmail.com)'; // !! Remember to change this !!*/

---

<BaseLayout title={teamEntry.data.name}>

  <div class="max-w-5xl mx-auto">
    {/*DIV CON LOGO E NOME DEL TEAM */}
{/* ==============================================
  ENHANCED TEAM HERO BANNER
  ==============================================
  */}
  {teamPhotoUrl && (
    <div class="relative w-full h-[450px] sm:h-[500px] overflow-hidden -mt-[64px] mb-8"> {/* Adjusted height and negative margin to pull it up under the header */}
      
      {/* Background Image */}
      <img 
        src={teamPhotoUrl} 
        alt={`${teamEntry.data.name} Team Photo`} 
        class="w-full h-full object-cover object-top filter brightness-90 saturate-110"
      />

      {/* 1. Dark Gradient Overlay (Top to Bottom) - Blends into page */}
      <div class="absolute inset-0 bg-gradient-to-t from-black via-black/40 to-black/20"></div>

      {/* 2. Optional: Subtle Vignette Effect (Darken edges) */}
      <div class="absolute inset-0 shadow-[inset_0_0_100px_rgba(0,0,0,0.8)]"></div>

      {/* Content Overlay (Text and Logo) */}
      <div class="absolute inset-0 flex flex-col justify-end p-8 pb-12 sm:p-12 sm:pb-16 lg:p-16 lg:pb-20">
        
        <div class="max-w-7xl mx-auto w-full"> {/* To align content with your main container */}
          
          {/* Team Logo (Adjust positioning as needed) */}
          {teamEntry.data.logo && (
            <img 
              src={teamEntry.data.logo.replace('/upload/', '/upload/w_150,f_auto,q_auto/') } 
              alt={`${teamEntry.data.name} Logo`}
              class="w-24 h-24 sm:w-32 sm:h-32 object-contain mb-4 drop-shadow-lg"
              loading="eager"
            />
          )}

          {/* Region */}
          <p class="text-neutral-300 text-lg sm:text-xl font-semibold drop-shadow-md">
            {teamEntry.data.region}
          </p>
          
          {/* Team Name */}
          <h1 class="font-title text-5xl sm:text-6xl lg:text-7xl font-bold text-white leading-tight mt-2 drop-shadow-lg">
            {teamEntry.data.name}
          </h1>
        </div>

      </div>
    </div>
  )}

    {/*ROSTER E GIOCATORI*/}
    <h2 class="text-3xl font-bold text-white font-title mt-8 mb-4">
      Active Roster
    </h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
      {
        roster.map((player) => {
          // 1. Get the headshot URL
          // We'll use 'object-contain', so a high-res, 'fit' image is best.
          const headshotUrl = player.data.headshot
            ? player.data.headshot.replace(
                "/upload/",
                "/upload/w_600,c_fit,b_transparent,f_auto,q_auto:best/",
              )
            : null;

          return (
            <a
              href={`/players/${player.slug}/`}
              class="
              relative block h-80 w-full /* Set a fixed height */
              rounded-lg 
              border border-neutral-800 
              transition-all duration-300 
              hover:border-amber-500/50 hover:scale-[1.02]
              shadow-lg overflow-hidden group
            "
            >
              {/* 1. The Angled Frame (holds the image) */}
              <div
                class="
              absolute inset-0 h-full w-full 
              overflow-hidden -skew-y-3 
              bg-neutral-800/50
              shadow-[0_0_0_1px_rgba(245,158,11,0.2)]
            "
              >
                {headshotUrl ? (
                  <img
                    src={headshotUrl}
                    alt={player.data.name}
                    class="
                    relative w-full h-full 
                    object-contain object-top /* Use 'object-contain' */
                    skew-y-3 /* Un-skew the image */
                    transition-transform duration-300
                    group-hover:scale-105
                  "
                    width="600"
                    height="600"
                    loading="lazy"
                  />
                ) : (
                  <div class="h-full w-full skew-y-3" />
                )}
              </div>

              {/* 2. Dark Gradient Overlay (for text) */}
              <div
                class="
              absolute bottom-0 left-0 right-0 h-1/2 
              bg-gradient-to-t from-black/90 via-black/70 to-transparent
            "
              />

              {/* 3. Player Info (at the bottom) */}
              <div class="absolute bottom-0 left-0 right-0 p-4">
                <h3 class="text-3xl font-bold text-white font-title">
                  {player.data.name}
                </h3>
                <p class="text-xl text-yellow-400">{player.data.role}</p>
              </div>
            </a>
          );
        })
      }
    </div>

    <div class="prose prose-invert prose-lg bg-neutral-900 p-8 rounded-lg mt-8 border border-neutral-800">
      <Content />
    </div>

    {/*TROFEI E STORICO DEL TEAM */}
    {
      teamEntry.data.achievements && teamEntry.data.achievements.length > 0 && (
        <div class="bg-neutral-900 p-8 rounded-lg mt-8 border border-neutral-800">
          <h2 class="font-title text-3xl text-white mb-6">
            Major Achievements
          </h2>
          <ul class="list-none pl-0">
            {teamEntry.data.achievements.map((note) => (
              <li class="text-md text-gray-300 border-b border-neutral-800 py-2">
                {note}
              </li>
            ))}
          </ul>
        </div>
      )
    }

    {/*SOCIAL DEL TEAM */}
    {
      teamEntry.data.socials && (
        <div class="bg-neutral-900 p-8 rounded-lg mt-8 border border-neutral-800">
          <h2 class="font-title text-3xl text-white mb-6">Follow</h2>
          <div class="flex flex-wrap gap-4">
            {/* Twitter / X */}
            {teamEntry.data.socials.twitter && (
              <a
                href={teamEntry.data.socials.twitter}
                target="_blank"
                rel="noopener noreferrer"
                class="flex items-center gap-2 p-3 bg-neutral-800 rounded-lg border border-neutral-700 hover:border-blue-400"
              >
                <span class="font-bold text-white">Twitter / X</span>
              </a>
            )}

            {/* Website */}
            {teamEntry.data.socials.website && (
              <a
                href={teamEntry.data.socials.website}
                target="_blank"
                rel="noopener noreferrer"
                class="flex items-center gap-2 p-3 bg-neutral-800 rounded-lg border border-neutral-700 hover:border-amber-500"
              >
                <span class="font-bold text-white">Official Website</span>
              </a>
            )}
          </div>
        </div>
      )
    }

    {/*QUIZ DEL TEAM */}
    <div class="bg-neutral-900 p-8 rounded-lg mt-8 border border-neutral-800">
      <h2 class="font-title text-3xl text-white mb-6">Team Quiz</h2>
      {/*richiamo il componente React che crea il quiz basandosi sulle domande create prima*/}
      <Quiz questions={teamQuizQuestions} client:load />
    </div>
  </div>
</BaseLayout>
