---
// src/pages/teams/[...slug].astro
export const prerender = false;

import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, getEntry } from 'astro:content';
import IconTwitter from '../../components/icons/IconTwitter.astro';
import IconTwitch from '../../components/icons/IconTwitch.astro';
import IconWebsite from '../../components/icons/IconWebsite.astro';
import Quiz from '../../components/Quiz.tsx';
import { generateTeamQuiz } from '../../lib/quizGenerator';
import { fetchRecentMatches } from '../../lib/fetchMatches';

// 1. GET DATA
const { slug } = Astro.params;
const teamEntry = await getEntry('teams', slug);

if (!teamEntry) {
  return new Response(null, { status: 404, statusText: 'Not Found' });
}

const allPlayers = await getCollection('players');
const { Content } = await teamEntry.render();
const roster = allPlayers.filter(player => player.data.team === teamEntry.slug);
const allTeams = await getCollection('teams');

// 2. PREPARE VISUALS
const teamColor = teamEntry.data.colour || '#f59e0b'; 

const bannerUrl = teamEntry.data.banner
  ? teamEntry.data.banner.replace('/upload/', '/upload/w_1920,h_1080,c_fill,q_auto,f_auto/')
  : 'https://images.contentstack.io/v3/assets/blt321317473c90505c/blt04c04346385d3bdd/65f208333626118536797020/OWCS_Stage1_Korea_Day6_Match2_FAL_vs_T1_6.jpg';

const logoUrl = teamEntry.data.logo.replace('/upload/', '/upload/w_400,h_400,c_pad,f_auto,q_auto/');

// 3. FETCH LIVE DATA
const apiKey = import.meta.env.LIQUIPEDIA_API_KEY;
const teamName = teamEntry.data.liquipediaName || teamEntry.data.name;
const myUserAgent = 'OWCS-Nexus (your-email@example.com)';

const recentMatches = await fetchRecentMatches(teamName, apiKey, myUserAgent);
const teamQuizQuestions = generateTeamQuiz(teamEntry, roster, allPlayers, allTeams);
---

<BaseLayout title={teamEntry.data.name} fullWidth={true}>
  
  {/* ==============================================
  1. HERO WALLPAPER (Immersive Background)
  ============================================== */}
  <div class="relative w-full h-[80vh] overflow-hidden rounded-xl">
    <img 
      src={bannerUrl} 
      alt={`${teamEntry.data.name} Background`} 
      class="w-full h-full object-cover object-center scale-105 filter brightness-[0.4]"
    />
    <div class="absolute inset-0 bg-gradient-to-b from-neutral-950/30 via-neutral-950/60 to-neutral-950"></div>
  </div>

  {/* ==============================================
  2. MAIN CONTENT CONTAINER (Overlapping)
  ============================================== */}
  <div class="max-w-7xl mx-auto px-4 relative z-10 -mt-64 md:-mt-80 pb-24">
    
    {/* TEAM HEADER CARD */}
    <div 
      class="bg-neutral-900/80 backdrop-blur-xl border rounded-3xl overflow-hidden shadow-2xl mb-16"
      style={`border-color: ${teamColor}40; box-shadow: 0 20px 50px -20px ${teamColor}30;`}
    >
      <div class="relative p-8 md:p-12 flex flex-col md:flex-row items-center gap-8 md:gap-12">
        
        {/* Logo */}
        <div class="relative shrink-0">
          <div 
            class="absolute inset-0 blur-[60px] opacity-30 rounded-full"
            style={`background-color: ${teamColor};`}
          ></div>
          <img 
            src={logoUrl} 
            alt={teamEntry.data.name} 
            class="w-32 h-32 md:w-48 md:h-48 object-contain drop-shadow-2xl relative z-10" 
          />
        </div>

        {/* Info Block */}
        <div class="text-center md:text-left w-full">
          
          <div class="flex items-center justify-center md:justify-start gap-3 mb-4">
            {teamEntry.data.isPartner && (
               <span 
                 class="text-black text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider shadow-lg"
                 style={`background-color: ${teamColor};`}
               >
                Partner Team
              </span>
            )}
            <span class="text-neutral-400 font-bold uppercase tracking-wider text-sm border border-neutral-700 px-3 py-1 rounded-full bg-neutral-800/50">
              {teamEntry.data.region}
            </span>
          </div>

          <h1 class="text-5xl md:text-7xl font-title text-white mb-6 tracking-tight drop-shadow-lg">
            {teamEntry.data.name}
          </h1>
          
          {/* Social Links */}
          {teamEntry.data.socials && (
             <div class="flex flex-wrap gap-3 justify-center md:justify-start">
                {teamEntry.data.socials.twitter && (
                  <a href={teamEntry.data.socials.twitter} target="_blank" class="p-2 bg-neutral-800/50 hover:bg-blue-500/20 border border-neutral-700 hover:border-blue-500 rounded-lg transition-colors text-neutral-400 hover:text-blue-400">
                  <IconTwitter class="w-5 h-5" />
                  </a>
                )}
                {teamEntry.data.socials.twitch && (
                  <a href={teamEntry.data.socials.twitch} target="_blank" class="p-2 bg-neutral-800/50 hover:bg-purple-500/20 border border-neutral-700 hover:border-purple-500 rounded-lg transition-colors text-neutral-400 hover:text-purple-400">
                  <IconTwitch class="w-5 h-5" />
                  </a>
                )}
                {teamEntry.data.socials.website && (
                  <a href={teamEntry.data.socials.website} target="_blank" class="p-2 bg-neutral-800/50 hover:bg-emerald-500/20 border border-neutral-700 hover:border-emerald-500 rounded-lg transition-colors text-neutral-400 hover:text-emerald-400">
                  <IconWebsite class="w-5 h-5" />
                  </a>
                )}
             </div>
          )}
        </div>
      </div>
    </div>

    {/* ==============================================
    3. TWO COLUMN CONTENT (Roster vs Info)
    ============================================== */}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* LEFT: ROSTERS */}
        <div class="lg:col-span-2 space-y-16">
            
            {/* ACTIVE ROSTER */}
            <div>
                <h2 class="text-3xl font-bold text-white font-title mb-6 flex items-center gap-3">
                    <span class="w-1.5 h-8 rounded-full" style={`background-color: ${teamColor};`}></span>
                    Active Roster
                </h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    {roster.map(player => {
                        const headshotUrl = player.data.headshot ? player.data.headshot.replace('/upload/', '/upload/w_600,c_fit,b_transparent,f_auto,q_auto:best/') : null;
                        return (
                            <a 
                                href={`/players/${player.slug}/`} 
                                class="relative h-80 bg-neutral-900 rounded-xl border border-neutral-800 overflow-hidden group hover:border-white/20 transition-all hover:-translate-y-1 shadow-lg"
                                style={`border-color: ${teamColor}33;`}
                            >
                                {/* Angled BG */}
                                <div class="absolute inset-0 bg-neutral-800/50 -skew-y-3 scale-110 origin-top-left" style={`box-shadow: inset 0 0 20px ${teamColor}20;`}></div>
                                
                                {/* Image */}
                                {headshotUrl ? (
                                    <img src={headshotUrl} class="absolute inset-0 w-full h-full object-contain object-top pt-4 transition-transform duration-500 group-hover:scale-105" loading="lazy" />
                                ) : <div class="w-full h-full opacity-5"></div>}
                                
                                {/* Text Overlay */}
                                <div class="absolute bottom-0 left-0 right-0 p-5 bg-gradient-to-t from-black/90 via-black/60 to-transparent">
                                    <h3 class="text-3xl font-title text-white mb-0">{player.data.name}</h3>
                                    <p class="font-bold opacity-90" style={`color: ${teamColor};`}>{player.data.role}</p>
                                </div>
                            </a>
                        )
                    })}
                </div>
            </div>

            {/* COACHING STAFF */}
            {teamEntry.data.coaches && teamEntry.data.coaches.length > 0 && (
                <div>
                    <h2 class="text-3xl font-bold text-white font-title mb-6 flex items-center gap-3">
                        <span class="w-1.5 h-8 rounded-full bg-neutral-600"></span>
                        Coaching Staff
                    </h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        {teamEntry.data.coaches.map(coach => {
                            const headshotUrl = coach.headshot ? coach.headshot.replace('/upload/', '/upload/w_600,c_fit,b_transparent,f_auto,q_auto:best/') : null;
                            const fallbackBgUrl = !headshotUrl && teamEntry.data.logo ? teamEntry.data.logo.replace('/upload/', '/upload/w_300,c_pad,e_grayscale,o_10,f_auto,q_auto/') : null;
                            
                            return (
                                <div 
                                    class="relative h-64 bg-neutral-900 rounded-xl border border-neutral-800 overflow-hidden"
                                    style={`border-color: ${teamColor}33;`}
                                >
                                     {/* BG Fallback */}
                                     {fallbackBgUrl && <img src={fallbackBgUrl} class="absolute inset-0 w-full h-full object-contain p-8 opacity-30" />}
                                     
                                     {/* Headshot */}
                                     {headshotUrl && <img src={headshotUrl} class="absolute inset-0 w-full h-full object-contain object-bottom transition-transform duration-500 hover:scale-105" loading="lazy"/>}
                                     
                                     {/* Text */}
                                     <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/90 via-black/60 to-transparent text-center">
                                        <h3 class="text-2xl font-title text-white">{coach.name}</h3>
                                        <p class="text-sm font-bold text-neutral-400 uppercase tracking-wider">{coach.role}</p>
                                     </div>
                                </div>
                            )
                        })}
                    </div>
                </div>
            )}
        </div>

        {/* --- RIGHT: SIDEBAR (Matches, Trophies, Bio) --- */}
        <div class="space-y-8">
            
            {/* MATCHES CARD */}
            <div class="bg-neutral-900 border border-neutral-800 rounded-2xl p-6 shadow-xl">
                <h3 class="text-xl font-title text-white mb-4 border-b border-neutral-800 pb-2">Recent Matches</h3>
                {recentMatches.length > 0 ? (
                    <div class="space-y-3">
                        {recentMatches.map(match => (
                            <div class="bg-neutral-950/50 p-3 rounded-lg border border-neutral-800 flex justify-between items-center">
                                <div class={`font-bold text-sm ${match.teamLeft.toLowerCase().includes(teamName.toLowerCase()) ? 'text-white' : 'text-neutral-500'}`}>{match.teamLeft}</div>
                                <div class="px-2 py-1 bg-neutral-800 rounded text-xs font-mono text-amber-500 font-bold whitespace-nowrap mx-2">
                                    {match.scoreLeft} - {match.scoreRight}
                                </div>
                                <div class={`font-bold text-sm text-right ${match.teamRight.toLowerCase().includes(teamName.toLowerCase()) ? 'text-white' : 'text-neutral-500'}`}>{match.teamRight}</div>
                            </div>
                        ))}
                    </div>
                ) : (
                    <p class="text-neutral-500 text-sm italic">No recent matches found.</p>
                )}
            </div>

            {/* TROPHIES CARD */}
            {teamEntry.data.achievements && teamEntry.data.achievements.length > 0 && (
                <div class="bg-neutral-900 border border-neutral-800 rounded-2xl p-6 shadow-xl relative overflow-hidden">
                    <h3 class="text-xl font-title text-white mb-4 border-b border-neutral-800 pb-2">Achievements</h3>
                    <ul class="space-y-2">
                        {teamEntry.data.achievements.map(ach => (
                            <li class="flex gap-3 text-sm text-neutral-300">
                                <span>{ach}</span>
                            </li>
                        ))}
                    </ul>
                </div>
            )}

            {/* ABOUT CARD */}
            <div class="bg-neutral-900 border border-neutral-800 rounded-2xl p-6 shadow-xl">
                <h3 class="text-xl font-title text-white mb-4 border-b border-neutral-800 pb-2">About</h3>
                <div class="prose prose-invert prose-sm max-w-none text-neutral-400">
                    <Content />
                </div>
            </div>
            
             {/* QUIZ CARD */}
            <div class="bg-neutral-900 border border-neutral-800 rounded-2xl p-6 shadow-xl">
                <h3 class="text-xl font-title text-white mb-4 border-b border-neutral-800 pb-2">Trivia</h3>
                 <Quiz questions={teamQuizQuestions} client:load />
            </div>

        </div>

    </div>

  </div>
</BaseLayout>