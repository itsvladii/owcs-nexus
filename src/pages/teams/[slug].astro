---
// 1. STATIC MODE (No 'prerender = false')
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import IconTwitter from "../../components/icons/IconTwitter.astro";
import IconTwitch from "../../components/icons/IconTwitch.astro";
import IconWebsite from "../../components/icons/IconWebsite.astro";
import LiveBadge from "../../components/teamComps/LiveBadge.tsx";
import { fetchFaceitStats } from "../../lib/stats/fetchAdvStats.ts";

// We use the "Fetch All" function to get the master list once during build
import { fetchAllSeasonMatches } from "../../lib/stats/fetchMatches.ts";

// --- 2. GETSTATICPATHS (The Brains) ---
export async function getStaticPaths() {
  const allTeams = await getCollection("teams");
  const allPlayers = await getCollection("players");

  // A. Fetch global match data ONCE
  const apiKey = import.meta.env.LIQUIPEDIA_API_KEY;
  const faceitKey = import.meta.env.FACEIT_API_KEY;
  const userAgent = "OWCS-Nexus (barcanvladi@gmail.com)";
  const globalMatches = await fetchAllSeasonMatches(apiKey, userAgent);

  // Helper for logos (Proxy)
  const getLogo = (op: any) => {
    if (!op) return null;
    let url = op.teamtemplate?.imagedarkurl || op.iconurl;
    return url ? `https://wsrv.nl/?url=${encodeURIComponent(url)}` : null;
  };

  // B. Build pages for each team
  return Promise.all(
    allTeams.map(async (teamEntry) => {
      const TEAM_ALIASES: Record<string, string> = {
        "All Gamers Global": "WAE",
        WAY: "WAE",
        "Once Again": "Weibo Gaming",
        "Sign Esports": "NTMR",
        "1DIPVS100GORILLAS": "Quick Esports",
        "Team CC (Chinese orgless team)": "Team CC",
        "Cheeseburger (Korean team)": "Cheeseburger",
        "Gen.G Esports": "Gen.G",
      };

      function getNormalizedTeamName(name: string): string {
        return TEAM_ALIASES[name] || name;
      }

      function shortenTournamentName(name: string): string {
        if (!name) return "";

        let shortName = name;

        // Common replacements
        shortName = shortName.replace(/Overwatch Champions Series/g, "OWCS");
        shortName = shortName.replace(/Overwatch League/g, "OWL");
        shortName = shortName.replace(/Saudi eLeague/g, "SEL");
        shortName = shortName.replace(/ 20(\d\d)/g, " '$1");

        // Simplify Stages
        shortName = shortName.replace(/Stage (\d)/g, "S$1");
        shortName = shortName.replace(/Season (\d)/g, "S$1");

        // Example: "OWCS 2024 North America Stage 1" -> "OWCS NA S1"
        shortName = shortName.replace(/North America/g, "NA");
        shortName = shortName.replace(/Europe, Middle East & Africa/g, "EMEA");
        shortName = shortName.replace(/South Korea/g, "Korea");
        return shortName.trim();
      }

      // 1. Roster
      const roster = allPlayers.filter((p) => p.data.team === teamEntry.slug);
      const advancedStats = await fetchFaceitStats(
        teamEntry.data.FACEITname,
        teamEntry.data.region,
        faceitKey,
      );


      
      // 3. Matches (Filter from global list)
      const teamName = (
        teamEntry.data.liquipediaName || teamEntry.data.name
      ).toLowerCase();

      const recentMatches = globalMatches
        .filter((match: any) => {
          if (!match.match2opponents || match.match2opponents.length < 2)
            return false;
          const op1 = match.match2opponents[0].name.toLowerCase();
          const op2 = match.match2opponents[1].name.toLowerCase();
          // Fuzzy match check
          return (
            op1.includes(teamName) ||
            teamName.includes(op1) ||
            op2.includes(teamName) ||
            teamName.includes(op2)
          );
        })
        .sort(
          (a: any, b: any) =>
            new Date(b.date).getTime() - new Date(a.date).getTime(),
        ) // Newest first
        .slice(0, 3)
        .map((match: any) => {
          const op1 = match.match2opponents[0];
          const op2 = match.match2opponents[1];
          // Fix scores
          const s1 = op1.score === -1 ? 0 : (op1.score ?? 0);
          const s2 = op2.score === -1 ? 0 : (op2.score ?? 0);

          return {
            teamLeft: getNormalizedTeamName(op1.name) || "TBD",
            scoreLeft: s1,
            logoLeft: getLogo(op1),
            teamRight: getNormalizedTeamName(op2.name) || "TBD",
            scoreRight: s2,
            logoRight: getLogo(op2),
            tournament: shortenTournamentName(match.tournament),
            date: new Date(match.date).toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
            }),
          };
        });

      return {
        params: { slug: teamEntry.slug },
        props: {
          teamEntry,
          recentMatches,
          roster,
          advancedStats,
        },
      };
    }),
  );
}

// --- 3. GET DATA FROM PROPS ---
const { teamEntry, recentMatches, roster, advancedStats } =
  Astro.props;
const { Content } = await teamEntry.render();

// --- 4. PREPARE VISUALS ---
// Handle "color" vs "colour" spelling just in case
const teamColor = teamEntry.data.color || teamEntry.data["colour"] || "#f59e0b";

const bannerUrl = teamEntry.data.banner
  ? teamEntry.data.banner.replace(
      "/upload/",
      "/upload/w_1920,h_1080,c_fill,q_auto,f_auto/",
    )
  : "https://images.contentstack.io/v3/assets/blt321317473c90505c/blt04c04346385d3bdd/65f208333626118536797020/OWCS_Stage1_Korea_Day6_Match2_FAL_vs_T1_6.jpg";

const logoUrl = teamEntry.data.logo.replace(
  "/upload/",
  "/upload/w_400,h_400,c_pad,f_auto,q_auto/",
);
---

<BaseLayout title={teamEntry.data.name} fullWidth={true}>
  {
    /* ==============================================
  1. HERO WALLPAPER (Full Width)
  ============================================== */
  }
  <div
    class="relative w-full h-[80vh] md:h-[80vh] overflow-hidden group rounded-xl"
  >
    {/* Blurred Background */}
    <img
      src={bannerUrl}
      alt={`${teamEntry.data.name} Background`}
      class="w-full h-full object-cover object-center scale-105 filter brightness-[0.4] transition-transform duration-[3s] ease-out"
    />
    <div
      class="absolute inset-0 bg-gradient-to-b from-neutral-950/30 via-neutral-950/60 to-neutral-950"
    >
    </div>
  </div>

  {
    /* ==============================================
  2. MAIN DASHBOARD CONTENT
  ============================================== */
  }
  <div class="max-w-7xl mx-auto px-4 relative z-20 -mt-64 md:-mt-80 pb-24">
    {/* TEAM HEADER CARD */}
    <div
      class="bg-neutral-900/80 backdrop-blur-xl border rounded-3xl overflow-hidden shadow-2xl mb-16"
      style={`border-color: ${teamColor}40; box-shadow: 0 20px 50px -20px ${teamColor}30;`}
    >
      <div
        class="relative p-8 md:p-12 flex flex-col md:flex-row items-center gap-8 md:gap-12"
      >
        {/* Logo */}
        <div class="relative shrink-0">
          <div
            class="absolute inset-0 blur-[60px] opacity-30 rounded-full"
            style={`background-color: ${teamColor};`}
          >
          </div>
          <img
            src={logoUrl}
            alt={teamEntry.data.name}
            class="w-32 h-32 md:w-48 md:h-48 object-contain drop-shadow-2xl relative z-10"
          />
        </div>

        {/* Info Block */}
        <div class="text-center md:text-left w-full">
          <div
            class="flex items-center justify-center md:justify-start gap-3 mb-4"
          >
            {
              teamEntry.data.isPartner && (
                <span
                  class="text-black text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider shadow-lg"
                  style={`background-color: ${teamColor};`}
                >
                  Partner Team
                </span>
              )
            }
            <span
              class="text-neutral-400 font-bold uppercase tracking-wider text-sm border border-neutral-700 px-3 py-1 rounded-full bg-neutral-800/50"
              >{teamEntry.data.region}</span
            >
            <LiveBadge
              teamName={teamEntry.data.liquipediaName || teamEntry.data.name}
              client:load
            />
          </div>

          <h1
            class="text-5xl md:text-7xl font-title text-white mb-6 tracking-tight drop-shadow-lg"
          >
            {teamEntry.data.name}
          </h1>

          {/* Socials */}
          {
            teamEntry.data.socials && (
              <div class="flex flex-wrap gap-3 justify-center md:justify-start">
                {teamEntry.data.socials.twitter && (
                  <a
                    href={teamEntry.data.socials.twitter}
                    target="_blank"
                    class="p-2 bg-neutral-800/50 hover:bg-blue-500/20 border border-neutral-700 hover:border-blue-500 rounded-lg transition-colors text-neutral-400 hover:text-blue-400"
                  >
                    <IconTwitter class="w-5 h-5" />
                  </a>
                )}
                {teamEntry.data.socials.twitch && (
                  <a
                    href={teamEntry.data.socials.twitch}
                    target="_blank"
                    class="p-2 bg-neutral-800/50 hover:bg-purple-500/20 border border-neutral-700 hover:border-purple-500 rounded-lg transition-colors text-neutral-400 hover:text-purple-400"
                  >
                    <IconTwitch class="w-5 h-5" />
                  </a>
                )}
                {teamEntry.data.socials.website && (
                  <a
                    href={teamEntry.data.socials.website}
                    target="_blank"
                    class="p-2 bg-neutral-800/50 hover:bg-emerald-500/20 border border-neutral-700 hover:border-emerald-500 rounded-lg transition-colors text-neutral-400 hover:text-emerald-400"
                  >
                    <IconWebsite class="w-5 h-5" />
                  </a>
                )}
              </div>
            )
          }
        </div>
      </div>
    </div>

    {/* TWO COLUMN LAYOUT */}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      {/* --- LEFT: ROSTER --- */}
      <div class="lg:col-span-2 space-y-16">
        {/* ACTIVE ROSTER */}
        {/* ACTIVE ROSTER SECTION */}
        <div class="mb-24">
          <h2
            class="font-title text-4xl text-white italic mb-8 flex items-center gap-3"
          >
            {/* Dynamic Header Bar */}
            <span
              class="w-2 h-8 rounded-sm"
              style={`background-color: ${teamColor};`}></span>
            ACTIVE ROSTER
          </h2>

          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            {
              roster.map((player) => {
                const playerImage =
                  player.data.headshot || "/default-player.png";

                return (
                  <a
                    href={`/players/${player.slug}`}
                    class="group relative h-[400px] w-full bg-neutral-900 rounded-2xl overflow-hidden border border-neutral-800 hover:border-neutral-600 transition-all shadow-lg"
                  >
                    {/* 1. BACKGROUND IMAGE */}
                    <div class="absolute inset-0 z-0">
                      <img
                        src={playerImage}
                        alt={player.data.name}
                        class="w-full h-full object-cover object-top transition-transform duration-700 group-hover:scale-105"
                      />

                      {/* Dark Gradient (Readability) */}
                      <div class="absolute inset-0 bg-gradient-to-t from-black via-black/20 to-transparent opacity-80 group-hover:opacity-60 transition-opacity" />

                      {/* DYNAMIC TEAM COLOR TINT (On Hover) */}
                      {/* We use inline style for color, and Tailwind for opacity transition */}
                      <div
                        class="absolute inset-0 opacity-0 group-hover:opacity-20 transition-opacity duration-500 mix-blend-screen"
                        style={`background-color: ${teamColor};`}
                      />
                    </div>

                    {/* 4. CONTENT OVERLAY */}
                    <div class="absolute bottom-0 left-0 w-full p-6 z-10 translate-y-2 group-hover:translate-y-0 transition-transform">
                      {/* Role Badge with Dynamic Dot */}
                      <div class="flex items-center gap-2 mb-2 opacity-80 group-hover:opacity-100 transition-opacity">
                        <span
                          class="w-1.5 h-1.5 rounded-full"
                          style={`background-color: ${teamColor};`}
                        />
                        <span class="text-xs font-mono font-bold uppercase tracking-widest text-neutral-300">
                          {player.data.role}
                        </span>
                      </div>

                      {/* Player Name */}
                      <h3 class="text-5xl font-title font-black italic text-white leading-none tracking-tighter mb-1">
                        {player.data.name}
                      </h3>

                      {/* Real Name */}
                      <p class="text-sm text-neutral-400 font-medium h-0 overflow-hidden group-hover:h-auto group-hover:mt-1 transition-all duration-300 opacity-0 group-hover:opacity-100">
                        {player.data.fullName}
                      </p>

                      {/* Arrow Icon (Dynamic Hover Color) */}
                      <div
                        class="absolute right-6 bottom-6 opacity-0 group-hover:opacity-100 transition-all delay-100 transform translate-x-4 group-hover:translate-x-0"
                        style={`color: ${teamColor};`}
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          class="w-6 h-6"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke="currentColor"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M17 8l4 4m0 0l-4 4m4-4H3"
                          />
                        </svg>
                      </div>
                    </div>
                  </a>
                );
              })
            }
          </div>
        </div>

        {/* COACHING STAFF SECTION */}
        {
          teamEntry.data.coaches && teamEntry.data.coaches.length > 0 && (
            <div class="mb-24">
              <h2 class="font-title text-4xl text-white italic mb-8 flex items-center gap-3">
                {/* Dynamic Header Bar */}
                <span
                  class="w-2 h-8 rounded-sm"
                  style={`background-color: ${teamColor};`}
                />
                COACHING STAFF
              </h2>

              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                {teamEntry.data.coaches.map((coach) => {
                  // Fallback if no image is provided
                  const coachImage =
                    coach.headshot ||
                    "https://res.cloudinary.com/dt3c26567/image/upload/v1762938948/default-coach.png";

                  return (
                    <div class="group relative h-[400px] w-full bg-neutral-900 rounded-2xl overflow-hidden border border-neutral-800 hover:border-neutral-600 transition-all shadow-lg">
                      {/* 1. BACKGROUND IMAGE */}
                      <div class="absolute inset-0 z-0">
                        <img
                          src={coachImage}
                          alt={coach.name}
                          class="w-full h-full object-cover object-top transition-transform duration-700 group-hover:scale-105"
                        />

                        {/* Dark Gradient for Text Readability */}
                        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/20 to-transparent opacity-80 group-hover:opacity-60 transition-opacity" />

                        {/* Dynamic Team Color Tint on Hover */}
                        <div
                          class="absolute inset-0 opacity-0 group-hover:opacity-20 transition-opacity duration-500 mix-blend-screen"
                          style={`background-color: ${teamColor};`}
                        />
                      </div>

                      {/* 2. CONTENT OVERLAY */}
                      <div class="absolute bottom-0 left-0 w-full p-6 z-10 translate-y-2 group-hover:translate-y-0 transition-transform">
                        {/* Role Badge */}
                        <div class="flex items-center gap-2 mb-2 opacity-80 group-hover:opacity-100 transition-opacity">
                          <span
                            class="w-1.5 h-1.5 rounded-full"
                            style={`background-color: ${teamColor};`}
                          />
                          <span class="text-xs font-mono font-bold uppercase tracking-widest text-neutral-300">
                            {coach.role}
                          </span>
                        </div>

                        {/* Coach Name */}
                        <h3 class="text-4xl font-title font-black italic text-white leading-none tracking-tighter mb-1">
                          {coach.name}
                        </h3>

                        {/* Handle / Extra Info (Reveals on Hover) */}
                        <p class="text-sm text-neutral-400 font-medium h-0 overflow-hidden group-hover:h-auto group-hover:mt-1 transition-all duration-300 opacity-0 group-hover:opacity-100">
                          {coach.handle || "Tactical Staff"}
                        </p>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )
        }
      </div>

      {/* --- RIGHT: SIDEBAR --- */}
      <div class="space-y-8">
        {/* MATCHES CARD */}
        <div
          class="bg-neutral-900 border border-neutral-800 rounded-2xl p-6 shadow-xl relative overflow-hidden"
        >
          <div
            class="absolute top-0 left-0 w-1 h-full"
            style={`background-color: ${teamColor};`}
          >
          </div>

          <h3
            class="text-xl font-title text-white mb-4 border-b border-neutral-800 pb-2 flex justify-between items-center"
          >
            Recent Matches
            <span class="text-xs font-sans font-normal text-neutral-500"
              >Last 3</span
            >
          </h3>

          {
            recentMatches.length > 0 ? (
              <div class="space-y-3">
                {recentMatches.map((match) => (
                  <div class="bg-neutral-950/50 p-3 rounded-lg border border-neutral-800 flex flex-col gap-2">
                    <div class="flex items-center justify-between text-sm">
                      <span class="text-xs text-neutral-500">{match.date}</span>
                      <span class="text-[10px] text-neutral-600 uppercase tracking-wider truncate max-w-[120px]">
                        {match.tournament}
                      </span>
                    </div>
                    <div class="flex items-center justify-between">
                      {/* Left Team */}
                      <div class="flex items-center gap-2 flex-1 min-w-0">
                        {match.logoLeft ? (
                          <img
                            src={match.logoLeft}
                            class="w-6 h-6 object-contain"
                          />
                        ) : (
                          <div class="w-6 h-6 bg-neutral-800 rounded text-[8px] text-neutral-500 flex items-center justify-center">
                            ?
                          </div>
                        )}
                        <span
                          class={`font-bold text-sm truncate ${match.teamLeft.toLowerCase().includes(teamEntry.data.name.toLowerCase()) ? "text-white" : "text-neutral-400"}`}
                        >
                          {match.teamLeft}
                        </span>
                      </div>
                      {/* Score */}
                      <div class="px-2 py-0.5 bg-neutral-800 rounded text-xs font-mono text-amber-500 font-bold whitespace-nowrap mx-2">
                        {match.scoreLeft} - {match.scoreRight}
                      </div>
                      {/* Right Team */}
                      <div class="flex items-center gap-2 flex-1 justify-end min-w-0">
                        <span
                          class={`font-bold text-sm truncate text-right ${match.teamRight.toLowerCase().includes(teamEntry.data.name.toLowerCase()) ? "text-white" : "text-neutral-400"}`}
                        >
                          {match.teamRight}
                        </span>
                        {match.logoRight ? (
                          <img
                            src={match.logoRight}
                            class="w-6 h-6 object-contain"
                          />
                        ) : (
                          <div class="w-6 h-6 bg-neutral-800 rounded text-[8px] text-neutral-500 flex items-center justify-center">
                            ?
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <p class="text-neutral-500 text-sm italic p-4 text-center">
                No recent matches found.
              </p>
            )
          }
        </div>

        {
          advancedStats && (
            <div class="bg-neutral-900 border border-neutral-800 rounded-2xl p-6 shadow-xl relative overflow-hidden">
              <div
                class="absolute top-0 left-0 w-1 h-full"
                style={`background-color: ${teamColor};`}
              />

              <h3 class="text-xl font-title text-white mb-6 border-b border-neutral-800 pb-2 flex justify-between items-center">
                Platform Stats
                <span class="text-xs font-sans font-normal text-neutral-500 bg-neutral-800 px-2 py-0.5 rounded">
                  FACEIT
                </span>
              </h3>

              <div class="grid grid-cols-2 gap-4">
                {/* Win Rate (Big) */}
                <div class="col-span-2 bg-neutral-950/50 p-4 rounded-xl border border-neutral-800 flex items-center justify-between">
                  <div>
                    <p class="text-xs text-neutral-500 uppercase tracking-wider font-bold mb-1">
                      Win Rate
                    </p>
                    <p class="text-4xl font-mono font-bold text-white">
                      {advancedStats.winRate}%
                    </p>
                  </div>
                  {/* Visual Pie Chart (Simple CSS Conic Gradient) */}
                  <div
                    class="w-12 h-12 rounded-full border-4 border-neutral-800"
                    style={`background: conic-gradient(${teamColor} ${advancedStats.winRate}%, transparent 0); transform: rotate(-90deg);`}
                  ></div>
                </div>

                {/* Record */}
                <div class="bg-neutral-950/50 p-3 rounded-lg border border-neutral-800 text-center">
                  <p class="text-[10px] text-neutral-500 uppercase tracking-wider font-bold">
                    Maps
                  </p>
                  <p class="text-xl font-mono font-bold text-white">
                    {advancedStats.totalWins}{" "}
                    <span class="text-neutral-500 text-sm">/</span>{" "}
                    {advancedStats.totalMatches}
                  </p>
                  <p class="text-[10px] text-green-500 font-bold mt-1">WINS</p>
                </div>

                {/* Streaks */}
                <div class="bg-neutral-950/50 p-3 rounded-lg border border-neutral-800 text-center">
                  <p class="text-[10px] text-neutral-500 uppercase tracking-wider font-bold">
                    Map Streaks
                  </p>
                  <div class="flex justify-center gap-2 items-baseline">
                    <span class="text-xl font-mono font-bold text-white">
                      {advancedStats.currentStreak}
                    </span>
                    <span class="text-xs text-neutral-600">/</span>
                    <span class="text-sm font-mono font-bold text-neutral-400">
                      {advancedStats.longestStreak}
                    </span>
                  </div>
                  <p class="text-[10px] text-amber-500 font-bold mt-1">
                    CUR / MAX
                  </p>
                </div>

                {/* Recent Form (Last 5) */}
                <div class="col-span-2 mt-2">
                  <p class="text-[10px] text-neutral-500 uppercase tracking-wider font-bold mb-2">
                    Recent Map Form
                  </p>
                  <div class="flex gap-1">
                    {advancedStats.recentResults.map((res) => (
                      <div
                        class={`h-1.5 flex-1 rounded-full ${res === "1" ? "bg-green-500" : "bg-red-500"}`}
                      />
                    ))}
                  </div>
                </div>
              </div>
            </div>
          )
        }

        {/* TROPHIES */}
        {
          teamEntry.data.achievements &&
            teamEntry.data.achievements.length > 0 && (
              <div class="bg-neutral-900 border border-neutral-800 rounded-2xl p-6 shadow-xl relative overflow-hidden">
                <h3 class="text-xl font-title text-white mb-4 border-b border-neutral-800 pb-2">
                  Achievements
                </h3>
                <ul class="space-y-2">
                  {teamEntry.data.achievements.map((ach) => (
                    <li class="flex gap-3 text-sm text-neutral-300">
                      <span class="text-amber-500 shrink-0" />
                      <span>{ach}</span>
                    </li>
                  ))}
                </ul>
              </div>
            )
        }

        {/* ABOUT */}
        <div
          class="bg-neutral-900 border border-neutral-800 rounded-2xl p-6 shadow-xl"
        >
          <h3
            class="text-xl font-title text-white mb-4 border-b border-neutral-800 pb-2"
          >
            About
          </h3>
          <div class="prose prose-invert prose-sm max-w-none text-neutral-400">
            <Content />
          </div>
        </div>

      </div>
    </div>

  </div>
</BaseLayout>
