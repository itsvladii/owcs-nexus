---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getLatestTransfers} from '../lib/contentScripts/fetchTransfers.ts'
import TransferTicket from '../components/transferComps/TransferTicket.astro';
import FA_Row from '../components/transferComps/FA_Row.astro';

const DEV_MODE = false; 

let allTransfers = [];

if (DEV_MODE) {
    console.log("⚠️ DEV MODE: Using Mock Transfer Data");
    // Added some extra mocks to test the Free Agent logic
    allTransfers = [
        {
            date: new Date().toISOString(),
            player: "Proper",
            role: "Hyper Flex",
            from: "Team Falcons",
            to: "Crazy Raccoon",
            isImportant: true
        },
        // A Free Agent!
        {
            date: new Date(Date.now() - 100000000).toISOString(),
            player: "Viol2t",
            role: "Flex Support",
            from: "Shock",
            to: "Free Agent", 
            isImportant: true
        },
        // Another FA!
        {
            date: new Date(Date.now() - 200000000).toISOString(),
            player: "Fearless",
            role: "Main Tank",
            from: "Houston Outlaws",
            to: "Free Agent",
            isImportant: true
        },
        // This guy left then joined (Should NOT be FA)
        {
            date: new Date(Date.now() - 86400000).toISOString(), 
            player: "Rush",
            role: "Head Coach",
            from: "Free Agent",
            to: "Toronto Defiant",
            isImportant: true
        },
    ];
} else {
    allTransfers = await getLatestTransfers();
}

const groupedTransfers = [];

allTransfers.forEach((transfer) => {
    const lastGroup = groupedTransfers[groupedTransfers.length - 1];

    // Check if this transfer matches the previous one (Same Day, Same Teams)
    const isSameBatch = lastGroup && 
                        lastGroup.date === transfer.date &&
                        lastGroup.from === transfer.from &&
                        lastGroup.to === transfer.to;

    if (isSameBatch) {
        // Add player to the existing group
        lastGroup.players.push({ 
            name: transfer.player, 
            role: transfer.role 
        });
    } else {
        // Create a new group
        groupedTransfers.push({
            ...transfer,
            players: [{ name: transfer.player, role: transfer.role }] // Array of players
        });
    }
});
const meaningfulTransfers = groupedTransfers.filter(t => t.isImportant);
const displayTransfers = meaningfulTransfers.slice(0, 15);

// --- LOGIC 2: MARKET CALCULATION ---
// Find players whose *latest* status is "Free Agent"
const seenPlayers = new Set();
const freeAgents = [];

for (const t of allTransfers) {
    if (!seenPlayers.has(t.player)) {
        seenPlayers.add(t.player);
        
        // If their LATEST move was TO Free Agent (or empty), they are available.
        // Also exclude Coaches if you only want players.
        if ((t.to === "Free Agent" || t.to === "") && !t.role.toLowerCase().includes('coach')) {
            freeAgents.push(t);
        }
    }
}
// Take top 5 for the sidebar
const meaningfulFA=freeAgents.filter(t => t.isImportant)
const marketWatch = meaningfulFA.slice(0, 5);
---

<BaseLayout title="Transfer Hub">
    
    <div class="relative py-20 bg-neutral-900 border-b border-neutral-800 overflow-hidden">
        <div class="absolute inset-0 opacity-20 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-amber-900 via-neutral-900 to-transparent"></div>
        <div class="container mx-auto px-4 relative z-10 text-center">
            <h1 class="font-title text-6xl md:text-8xl font-black italic text-white uppercase tracking-tighter mb-4">
                Transfer <span class="text-transparent bg-clip-text bg-gradient-to-r from-amber-500 to-amber-700 pr-4">Hub</span>
            </h1>
            <p class="font-mono text-neutral-400 text-sm md:text-base max-w-2xl mx-auto">
                Real-time tracking of roster changes, acquisitions, and releases across the OWCS.
            </p>
        </div>
    </div>

    <div class="container mx-auto px-4 py-12">
        <div class="flex flex-col lg:flex-row gap-12">
            
            {/* LEFT COLUMN: MAIN FEED */}
            <div class="flex-1">
                <div class="flex items-center justify-between mb-8">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <span class={`w-2 h-2 rounded-full ${DEV_MODE ? 'bg-yellow-500' : 'bg-green-500 animate-pulse'}`}></span>
                        LATEST TRANSFERS
                    </h3>
                    <span class="text-xs font-mono text-neutral-500">
                        {displayTransfers.length} TRANSFERS
                    </span>
                </div>

                <div class="space-y-4">
                    {displayTransfers.map(t => (
                        <TransferTicket transfer={t} />
                    ))}
                    {displayTransfers.length === 0 && (
                        <div class="p-12 text-center border border-dashed border-neutral-800 rounded-lg text-neutral-600">
                            No meaningful transfers detected recently.
                        </div>
                    )}
                </div>
            </div>

            {/* RIGHT COLUMN: MARKET WATCH & INFO */}
            <div class="w-full lg:w-96 space-y-8">

                <div class="bg-neutral-950 border border-neutral-800 p-6 rounded-xl">
                    <h4 class="text-xs font-bold text-neutral-500 uppercase tracking-widest mb-4">Transfer Window</h4>
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-3 h-3 bg-green-500 rounded-full shadow-[0_0_10px_#22c55e]"></div>
                        <span class="text-white font-bold text-lg">OPEN</span>
                    </div>
                    <p class="text-xs text-neutral-400 leading-relaxed">
                        Teams are currently permitted to sign free agents and trade contracts until the roster lock for Stage 1.
                    </p>
                </div>
                
                {/* 1. MERCENARY MARKET (NEW WIDGET) */}
                <div class="bg-neutral-950 border border-neutral-800 rounded-xl overflow-hidden">
                    <div class="p-4 border-b border-neutral-800 bg-neutral-900/50 flex justify-between items-center">
                        <h4 class="text-xs font-bold text-white uppercase tracking-widest flex items-center gap-2">
                             LFT WATCH
                        </h4>
                        <span class="text-[9px] text-neutral-500 font-mono">AVAILABLE NOW</span>
                    </div>
                    
                    <div class="p-4 space-y-3">
                        {marketWatch.length > 0 ? (
                            marketWatch.map(agent => (
                                <FA_Row agent={agent} />
                            ))
                        ) : (
                            <div class="text-center py-6 text-neutral-600 text-xs font-mono">
                                No notable free agents currently on the market.
                            </div>
                        )}
                    </div>
                    
                    {/* Fake Footer Link */}
                    {marketWatch.length > 0 && (
                        <div class="bg-neutral-900/30 p-3 text-center border-t border-white/5">
                            <span class="text-[10px] text-neutral-500 uppercase font-bold tracking-widest">
                                Showing Top {marketWatch.length} Available
                            </span>
                        </div>
                    )}
                </div>

                {/* 2. LEGEND (Existing) */}
                <div class="bg-neutral-950 border border-neutral-800 p-6 rounded-xl">
                    <h4 class="text-xs font-bold text-neutral-500 uppercase tracking-widest mb-4">Legend</h4>
                    <ul class="space-y-3">
                        <li class="flex items-center gap-3 text-xs">
                            <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
                            <span class="text-neutral-300">Acquisition (Joined Team)</span>
                        </li>
                        <li class="flex items-center gap-3 text-xs">
                            <span class="w-1.5 h-1.5 bg-red-500 rounded-full"></span>
                            <span class="text-neutral-300">Release (Left Team)</span>
                        </li>
                        <li class="flex items-center gap-3 text-xs">
                            <span class="w-1.5 h-1.5 bg-amber-500 rounded-full"></span>
                            <span class="text-neutral-300">Transfer (Team to Team)</span>
                        </li>
                    </ul>
                </div>

            </div>

        </div>
    </div>

</BaseLayout>