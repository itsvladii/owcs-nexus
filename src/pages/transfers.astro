---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getLatestTransfers} from '../lib/contentScripts/fetchTransfers.ts'
import TransferTicket from '../components/transferComps/TransferTicket.astro';
import FA_Row from '../components/transferComps/FA_Row.astro';
import '../styles/global.css'

const DEV_MODE = false; 

let allTransfers = [];

if (DEV_MODE) {
    console.log("⚠️ DEV MODE: Using Mock Transfer Data");
    // Added some extra mocks to test the Free Agent logic
    allTransfers = [
        {
            date: new Date().toISOString(),
            player: "Proper",
            role: "Hyper Flex",
            from: "Team Falcons",
            to: "Crazy Raccoon",
            isImportant: true
        },
        // A Free Agent!
        {
            date: new Date(Date.now() - 100000000).toISOString(),
            player: "Viol2t",
            role: "Flex Support",
            from: "Shock",
            to: "Free Agent", 
            isImportant: true
        },
        // Another FA!
        {
            date: new Date(Date.now() - 200000000).toISOString(),
            player: "Fearless",
            role: "Main Tank",
            from: "Houston Outlaws",
            to: "Free Agent",
            isImportant: true
        },
        // This guy left then joined (Should NOT be FA)
        {
            date: new Date(Date.now() - 86400000).toISOString(), 
            player: "Rush",
            role: "Head Coach",
            from: "Free Agent",
            to: "Toronto Defiant",
            isImportant: true
        },
    ];
} else {
    allTransfers = await getLatestTransfers();
}

const groupedTransfers = [];
allTransfers.forEach((transfer) => {
    const lastGroup = groupedTransfers[groupedTransfers.length - 1];
    const isSameBatch = lastGroup && lastGroup.date === transfer.date && lastGroup.from === transfer.from && lastGroup.to === transfer.to;

    if (isSameBatch) {
        lastGroup.players.push({ name: transfer.player, role: transfer.role });
    } else {
        groupedTransfers.push({ ...transfer, players: [{ name: transfer.player, role: transfer.role }] });
    }
});

const meaningfulTransfers = groupedTransfers.filter(t => t.isImportant);
const displayTransfers = meaningfulTransfers.slice(0, 15);

// Market Logic
const seenPlayers = new Set();
const freeAgents = [];
for (const t of allTransfers) {
    if (!seenPlayers.has(t.player)) {
        seenPlayers.add(t.player);
        if ((t.to === "Free Agent" || t.to === "") && !t.role.toLowerCase().includes('coach')) {
            freeAgents.push(t);
        }
    }
}
const meaningfulFA = freeAgents.filter(t => t.isImportant);
const marketWatch = meaningfulFA.slice(0, 5);
---

<BaseLayout title="Transfer Wire">
    
    {/* 1. HEADER SECTION (AMBER THEME) */}
    <div class="relative py-24 bg-neutral-950 border-b border-white/5 overflow-hidden">
        {/* Background Grid */}
        <div class="absolute inset-0 pointer-events-none bg-[linear-gradient(to_right,#80808012_1px,transparent_1px),linear-gradient(to_bottom,#80808012_1px,transparent_1px)] bg-[size:24px_24px] [mask-image:radial-gradient(ellipse_60%_50%_at_50%_0%,#000_70%,transparent_100%)]"></div>
        {/* Amber Glow */}
        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-[600px] h-[400px] bg-amber-600/10 blur-[100px] rounded-full mix-blend-screen pointer-events-none"></div>
        
        <div class="container mx-auto px-6 relative z-10 text-center">
            <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-amber-500/30 bg-amber-500/10 text-amber-400 text-[10px] font-bold uppercase tracking-widest mb-6">
                <span class="w-2 h-2 rounded-full bg-amber-500 animate-pulse"></span>
                Live Feed
            </div>

            <h1 class="font-title text-5xl md:text-8xl font-black text-white uppercase tracking-tighter mb-6">
                Transfer <span class="text-transparent bg-clip-text bg-gradient-to-r from-amber-400 to-orange-500">Wire</span>
            </h1>
            
            <p class="font-mono text-neutral-400 text-sm md:text-base max-w-xl mx-auto leading-relaxed">
                // SYSTEM LOG: Tracking real-time roster changes, acquisitions, and releases across the Global Circuit.
            </p>
        </div>
    </div>

    {/* 2. MAIN CONTENT GRID */}
    <div class="container mx-auto px-4 py-12">
        <div class="flex flex-col lg:flex-row gap-12 items-start">
            
            {/* LEFT COLUMN: THE FEED */}
            <div class="flex-1 w-full">
                
                {/* Feed Header */}
                <div class="flex items-center justify-between mb-6 pb-4 border-b border-white/5">
                     <h3 class="text-sm font-bold text-white uppercase tracking-widest flex items-center gap-2">
                        Latest Transactions
                    </h3>
                    <div class="flex items-center gap-2 text-[10px] font-mono text-neutral-500">
                        <span>SYNCED</span>
                        <span class="w-1.5 h-1.5 bg-amber-500 rounded-full animate-pulse"></span>
                    </div>
                </div>

                <div class="space-y-4">
                    {displayTransfers.map(t => (
                        <TransferTicket transfer={t} />
                    ))}
                    
                    {displayTransfers.length === 0 && (
                        <div class="py-20 text-center border border-dashed border-white/10 rounded-xl bg-white/[0.02]">
                            <p class="text-neutral-500 font-mono text-sm">No recent transactions found.</p>
                        </div>
                    )}
                </div>
            </div>

            {/* RIGHT COLUMN: SIDEBAR WIDGETS */}
            <div class="w-full lg:w-80 space-y-6 sticky top-6">

                {/* STATUS WIDGET */}
                <div class="bg-neutral-900/50 border border-white/5 p-5 rounded-none border-l-2 border-l-amber-500">
                    <h4 class="text-[10px] font-bold text-neutral-500 uppercase tracking-widest mb-2">Market Status</h4>
                    <div class="flex items-center gap-3">
                        <span class="text-2xl font-black text-white uppercase italic tracking-tight">OPEN</span>
                        <span class="px-2 py-0.5 bg-amber-500/20 text-amber-400 text-[10px] font-bold rounded border border-amber-500/30">STAGE 1</span>
                    </div>
                    <p class="text-[10px] text-neutral-500 mt-2 font-mono">
                        Free Agent signings enabled.
                    </p>
                </div>
                
                {/* FREE AGENT WATCHER */}
                <div class="bg-neutral-900 border border-white/5 overflow-hidden">
                    <div class="p-4 border-b border-white/5 bg-neutral-950 flex justify-between items-center">
                        <h4 class="text-xs font-bold text-white uppercase tracking-widest flex items-center gap-2">
                           LFT Watch
                        </h4>
                        <span class="text-[9px] text-amber-500 font-mono animate-pulse">● LIVE</span>
                    </div>
                    
                    <div class="divide-y divide-white/5">
                        {marketWatch.length > 0 ? (
                            marketWatch.map(agent => (
                                <FA_Row agent={agent} />
                            ))
                        ) : (
                            <div class="p-6 text-center text-neutral-600 text-xs font-mono">
                                No notable Free Agents.
                            </div>
                        )}
                    </div>
                </div>

                {/* LEGEND (Updated Colors) */}
                <div class="p-5 border border-white/5 bg-neutral-900/30">
                    <h4 class="text-[10px] font-bold text-neutral-500 uppercase tracking-widest mb-3">Transaction Types</h4>
                    <ul class="space-y-2">
                        <li class="flex items-center gap-3 text-xs">
                            <span class="text-emerald-500">↘</span>
                            <span class="text-neutral-400">Acquisition</span>
                        </li>
                        <li class="flex items-center gap-3 text-xs">
                            <span class="text-rose-500">↗</span>
                            <span class="text-neutral-400">Release</span>
                        </li>
                        <li class="flex items-center gap-3 text-xs">
                            <span class="text-amber-500">⇄</span>
                            <span class="text-neutral-400">Trade</span>
                        </li>
                    </ul>
                </div>

            </div>

        </div>
    </div>

</BaseLayout>