---
// src/pages/players/[...slug].astro
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { fetchRecentPov } from '../../lib/fetchPOV';
import { fetchAllSeasonMatches } from '../../lib/fetchRecent3Matches';
import IconTwitter from '../../components/icons/IconTwitter.astro';
import IconTwitch from '../../components/icons/IconTwitch.astro';

function getDistinguishedService(career) {
  if (!career) return [];
  
  const serviceMap = new Map();

  career.forEach(entry => {
    // If team exists, merge notes. If not, create entry.
    if (!serviceMap.has(entry.team)) {
      serviceMap.set(entry.team, { 
        name: entry.team, 
        years: [entry.date], 
        accolades: entry.notes || [] 
      });
    } else {
      const existing = serviceMap.get(entry.team);
      existing.years.push(entry.date); // Collect dates
      if (entry.notes) existing.accolades.push(...entry.notes);
    }
  });
  return Array.from(serviceMap.values()).sort((a, b) => {
     const aScore = a.accolades.length + (a.years.some(y => y.includes('Present')) ? 5 : 0);
     const bScore = b.accolades.length + (b.years.some(y => y.includes('Present')) ? 5 : 0);
     return bScore - aScore;
  });
}
// --- 1. GET STATIC PATHS ---
export async function getStaticPaths() {
  const allPlayers = await getCollection('players');
  const allTeams = await getCollection('teams');
  const apiKey = import.meta.env.LIQUIPEDIA_API_KEY;
  const userAgent = 'OWCS-Nexus-BuildBot/1.0';
  let allSeasonMatches = [];
  
  try {
     allSeasonMatches = await fetchAllSeasonMatches(apiKey, userAgent);
  } catch (e) {
     console.error("⚠️ Failed to fetch matches for player pages:", e);
  }

  const pages = await Promise.all(
    allPlayers.map(async (playerEntry) => {
      const pData = playerEntry.data;
      let mostRecentPovUrl = null; 
      if (pData.featuredPovId) {
        mostRecentPovUrl = `https://www.youtube.com/embed/${pData.featuredPovId}`;
      } else {
        const youtubeKey = import.meta.env.YOUTUBE_API_KEY;
        if (youtubeKey) {
            try {
                const POV_CHANNEL_ID = "UCWcMwj6iZCuQ8Klgd42P2Dg"; 
                mostRecentPovUrl = await fetchRecentPov(pData.name, POV_CHANNEL_ID, youtubeKey);
            } catch (e) {}
        }
      }

      const teamEntry = allTeams.find(t => t.slug === pData.team);
      const teamName = teamEntry ? teamEntry.data.name.toLowerCase() : pData.team.toLowerCase();
      
      const playerMatches = allSeasonMatches.filter(m => {
        const t1 = m.match2opponents[0]?.name?.toLowerCase() || '';
        const t2 = m.match2opponents[1]?.name?.toLowerCase() || '';
        return t1.includes(teamName) || t2.includes(teamName);
      });

      const now = new Date();
      const history = playerMatches
        .filter(m => new Date(m.date) < now)
        .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime())
        .slice(0, 5);

      const upcoming = playerMatches
        .filter(m => new Date(m.date) >= now)
        .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())
        .slice(0, 3);

      const wins = history.filter(m => {
        const isTeam1 = m.match2opponents[0].name.toLowerCase().includes(teamName);
        const winner = m.winner; 
        return (isTeam1 && winner === '1') || (!isTeam1 && winner === '2');
      }).length;
      
      // --- NEW: MAP DIFFERENTIAL LOGIC ---
      let mapsWon = 0;
      let mapsLost = 0;

      const recentDiffs = history.slice(0, 5).reverse().map(m => {
         const isTeam1 = m.match2opponents[0].name.toLowerCase().includes(teamName);
         const s1 = parseInt(m.match2opponents[0].score || '0');
         const s2 = parseInt(m.match2opponents[1].score || '0');
         
         // Calculate diff for THIS player's team
         const matchDiff = isTeam1 ? (s1 - s2) : (s2 - s1);
         
         // Accumulate totals while we are at it
         if (isTeam1) { mapsWon += s1; mapsLost += s2; } 
         else { mapsWon += s2; mapsLost += s1; }

         return { 
            diff: matchDiff, 
            opponent: m.match2opponents.find(op => !op.name.toLowerCase().includes(teamName))?.name || 'Op',
            date: m.date
         };
      });
      
      const mapDiff = mapsWon - mapsLost;
      const winRate = history.length > 0 ? Math.round((wins / history.length) * 100) : 0;

      return {
        params: { slug: playerEntry.slug },
        props: { 
          playerEntry, teamEntry, mostRecentPovUrl,
          // Pass 'recentDiffs' to props
          stats: { history, upcoming, winRate, totalGames: history.length, mapDiff, mapsWon, mapsLost, recentDiffs }
        },
      };
    })
  );
  return pages;
}

// --- 2. PAGE PROPS ---
const { playerEntry, teamEntry, mostRecentPovUrl, stats } = Astro.props;
const p = playerEntry.data;
const { Content } = await playerEntry.render();

// --- 3. FETCH COLLECTIONS ---
const allPlayers = await getCollection('players');
const allTeams = await getCollection('teams');

// --- 4. ASSET HELPERS ---
const cloudinaryBaseUrl = p.headshot
  ? p.headshot.split('/upload/')[0] + '/upload'
  : 'https://res.cloudinary.com/dm1bfprgq/image/upload';

function getHeroIcon(heroName) {
    const slug = heroName.toLowerCase().replace(' ', '-').replace('.', '').replace(':', '');
    return `https://res.cloudinary.com/dm1bfprgq/image/upload/f_auto,q_auto:best/v1762938945/${slug}.png`;
}

// Optimized Team Logo for the badge
const teamLogoUrl = teamEntry?.data.logo
  ? teamEntry.data.logo.replace('/upload/', '/upload/w_100,h_100,c_pad,f_auto,q_auto/')
  : null;

const teamColor = teamEntry?.data.colour || '#f59e0b';
---

<BaseLayout title={`${p.name} - Nexus`} fullWidth={true}>
  <link href="https://fonts.googleapis.com/css2?family=Rock+Salt&display=swap" rel="stylesheet">
  
  {/* =========================================================================
      1. CINEMATIC HERO SECTION
     ========================================================================= */}
  <div class="relative w-full h-[85vh] min-h-[600px] bg-neutral-950 overflow-hidden group">
    
    {/* --- A. BACKGROUND LAYERS --- */}
    <div class="absolute inset-0 z-0">

      {/* 2. Player Image */}
      {p.headshot ? (
        <img 
          src={p.headshot} 
          alt={p.name} 
          class="w-full h-full object-cover object-[center_20%] opacity-90 relative z-10"
        />
      ) : (
        <div class="w-full h-full bg-neutral-900 flex items-center justify-center relative z-10">
             <h1 class="text-[15rem] font-title text-neutral-800 opacity-50">{p.name[0]}</h1>
        </div>
      )}

      {/* 3. Vignette Gradients */}
      <div class="absolute inset-0 bg-gradient-to-t from-[#0a0a0a] via-[#0a0a0a]/40 to-transparent z-20"></div>
      <div class="absolute inset-0 bg-gradient-to-r from-[#0a0a0a]/90 via-transparent to-[#0a0a0a]/90 z-20"></div>

      {/* 5. Noise Texture */}
      <div class="absolute inset-0 opacity-20 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] brightness-100 contrast-150 mix-blend-overlay z-20"></div>
    </div>

    {/* --- B. PLAYER IDENTITY LAYER --- */}
    <div class="relative h-full max-w-7xl mx-auto px-6 flex flex-col justify-end pb-32 z-30">
       

       {/* INFO BLOCK */}
       <div class="relative">
          
          {/* BADGE ROW */}
          <div class="flex items-center gap-3 mb-4">
             
             {/* 1. TEAM LOGO BADGE */}
             {teamEntry ? (
                 <a href={`/teams/${teamEntry.slug}`} class="relative group/team w-10 h-10 shadow-lg transition-colors flex items-center justify-center">
                    {teamLogoUrl ? (
                        <img src={teamLogoUrl} class="w-10 h-10 object-contain drop-shadow-md" alt={teamEntry.data.name} />
                    ) : (
                        <span class="text-[10px] font-bold text-white">{teamEntry.data.name.substring(0,3).toUpperCase()}</span>
                    )}
                    
                    {/* Tooltip for Team Name */}
                    <div class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 px-2 py-1 bg-neutral-900 border border-neutral-700 text-white text-[10px] font-bold rounded opacity-0 group-hover/team:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-50 shadow-xl">
                        {teamEntry.data.name}
                    </div>
                 </a>
             ) : (
                 // Fallback text pill if no team entry exists
                 <span class="px-3 py-1 bg-white/10 backdrop-blur border border-white/20 rounded text-xs font-bold uppercase tracking-widest text-white shadow-lg">
                    {p.team}
                 </span>
             )}
             

             {/* 3. FLAG BADGE */}
             {p.flagUrl && (
                <div class="relative group/flag w-10 h-8 rounded overflow-hidden border border-white/20 shadow-sm cursor-help">
                   <img src={p.flagUrl} class="w-full h-full object-cover" />
                   <div class="absolute inset-0 bg-black/10 group-hover/flag:bg-transparent transition-colors"></div>
                   {/* Tooltip */}
                   <div class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 px-2 py-1 bg-neutral-900 border border-neutral-700 text-white text-[10px] font-bold rounded opacity-0 group-hover/flag:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-50 shadow-xl">
                      {p.nationality || 'Nationality'}
                   </div>
                </div>
             )}
          </div>

          {/* NAME */}
          <div class="relative inline-block mb-4">
             {/* 1. THE MAIN NAME (Blocky & Official) */}
             <h1 class="text-7xl md:text-9xl font-title text-white font-black italic tracking-tighter drop-shadow-2xl relative z-10">
               {p.name}
             </h1>      
          </div>
          
          {/* SIGNATURE HEROES */}
          <div class="flex flex-col md:flex-row md:items-center gap-12">
            <div class="border-l-4 pl-4 relative" style={`border-color: ${teamColor}`}>
                {/* Real Name */}
                <p class="text-2xl text-white font-medium leading-none">{p.fullName || p.name}</p>
            </div>

            {/* Signature Heroes */}
            {p.signatureHeroes && (
                <div class="flex items-center gap-4">
                <span class="text-xs text-neutral-500 font-bold uppercase tracking-widest">Signatures</span>
                <div class="flex items-center -space-x-3">
                    {p.signatureHeroes.map((hero) => (
                        <div class="w-12 h-12 rounded-lg bg-neutral-800 border-2 border-[#0a0a0a] overflow-hidden relative z-0 hover:z-10 hover:scale-110 transition-transform shadow-lg group/hero">
                            <img src={getHeroIcon(hero)} class="w-full h-full object-cover" alt={hero} /> 
                            <div class="absolute inset-0 bg-neutral-900/40 mix-blend-multiply opacity-0 group-hover/hero:opacity-0 transition-opacity"></div>
                        </div>
                    ))}
                </div>
                </div>
            )}
          </div>
       </div>
    </div>
   
  </div>

  {/* =========================================================================
      2. FLOATING DATA STRIP
     ========================================================================= */}
  <div class="relative z-40 -mt-24 max-w-7xl mx-auto px-6 mb-24">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
       
       {/* STAT 1: Role */}
       <div class="bg-neutral-900/80 backdrop-blur-md border border-white/10 p-6 rounded-xl shadow-2xl hover:border-amber-500/50 transition-colors group">
          <div class="flex justify-between items-start mb-2">
             <p class="text-neutral-500 text-xs font-bold uppercase tracking-widest">Role</p>
             <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-amber-500 opacity-50" viewBox="0 0 24 24" fill="currentColor"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
          </div>
          <p class="text-4xl font-title font-bold text-white group-hover:text-amber-500 transition-colors uppercase">
             {p.role}
          </p>
       </div>

       {/* STAT 2: Map Differentials */}
       <label class="relative bg-neutral-900/80 backdrop-blur-md border border-white/10 p-6 rounded-xl shadow-2xl hover:border-blue-500/50 transition-all cursor-pointer group h-[120px] block select-none overflow-hidden">
          
          {/* THE TOGGLE SWITCH (Hidden) */}
          <input type="checkbox" class="peer hidden" />

          {/* STATE A: THE SUMMARY (Default Visible) */}
          <div class="absolute inset-0 p-6 transition-all duration-300 ease-out peer-checked:opacity-0 peer-checked:scale-95 peer-checked:pointer-events-none">
             <div class="flex justify-between items-start mb-2">
                <p class="text-neutral-500 text-xs font-bold uppercase tracking-widest group-hover:text-blue-400 transition-colors">Map Diff</p>
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-blue-500 opacity-50 group-hover:scale-110 transition-transform" viewBox="0 0 24 24" fill="currentColor"><path d="M18.375 2.25c-1.035 0-1.875.84-1.875 1.875v15.75c0 1.035.84 1.875 1.875 1.875h.75c1.035 0 1.875-.84 1.875-1.875V4.125c0-1.035-.84-1.875-1.875-1.875h-.75zM9.75 8.625c0-1.035-.84-1.875-1.875-1.875h-.75c-1.035 0-1.875.84-1.875 1.875v11.25c0 1.035.84 1.875 1.875 1.875h.75c1.035 0 1.875-.84 1.875-1.875V8.625zM3 13.125c0-1.035-.84-1.875-1.875-1.875h-.75C.34 11.25 0 12.09 0 13.125v6.75C0 20.91.84 21.75 1.875 21.75h.75c1.035 0 1.875-.84 1.875-1.875v-6.75z" /></svg>
             </div>
             <div class="flex items-baseline gap-2">
                <p class={`text-4xl font-mono font-bold tracking-tight ${stats.mapDiff >= 0 ? 'text-blue-500' : 'text-red-500'}`}>
                   {stats.mapDiff > 0 ? '+' : ''}{stats.mapDiff}
                </p>
                <span class="text-xs text-neutral-400 font-bold uppercase">Net Maps</span>
             </div>
             <p class="text-[10px] text-neutral-500 mt-1">
                <span class="text-white">{stats.mapsWon}W</span> - <span class="text-neutral-400">{stats.mapsLost}L</span> Total
             </p>
             <div class="absolute bottom-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity text-[10px] text-blue-400 font-mono uppercase tracking-widest">
                Click for History →
             </div>
          </div>

          {/* STATE B: THE GRAPH (Hidden by default) */}
          <div class="absolute inset-0 p-4 flex flex-col justify-end opacity-0 scale-105 transition-all duration-300 ease-out peer-checked:opacity-100 peer-checked:scale-100 bg-neutral-900">
              <p class="absolute top-4 left-4 text-[10px] font-bold text-neutral-500 uppercase tracking-widest">Last 5 Matches</p>
              
              {/* THE BAR CHART */}
              <div class="flex items-end justify-between gap-1 h-16 w-full pb-1 border-b border-white/10 relative">
                 {/* Center Line (0) */}
                 <div class="absolute top-1/2 left-0 right-0 h-px bg-white/5 z-0"></div>

                 {stats.recentDiffs.map(match => {
                    // Max height is usually +/- 3. We normalize to fit container.
                    // Height = abs(diff) * 25% (roughly)
                    const heightPct = Math.min(100, Math.abs(match.diff) * 25); 
                    const isPos = match.diff > 0;
                    const isZero = match.diff === 0;
                    
                    return (
                       <div class="relative flex-1 flex flex-col items-center justify-center group/bar h-full z-10">
                          {/* The Bar */}
                          {!isZero ? (
                              <div 
                                style={`height: ${heightPct}%;`} 
                                class={`w-2 md:w-3 rounded-sm mb-auto mt-auto transition-all ${isPos ? 'bg-blue-500 mb-[50%]' : 'bg-red-500 mt-[50%]'}`}
                              ></div>
                          ) : (
                              <div class="w-2 h-1 bg-neutral-600 rounded-full"></div>
                          )}
                          
                          {/* Tooltip on Hover */}
                          <div class="absolute bottom-full mb-1 opacity-0 group-hover/bar:opacity-100 transition-opacity bg-black border border-white/10 px-2 py-1 rounded text-[9px] text-white whitespace-nowrap z-50">
                             {match.diff > 0 ? '+' : ''}{match.diff} vs {match.opponent}
                          </div>
                       </div>
                    )
                 })}
              </div>
          </div>
       </label>

       {/* STAT 3: Socials */}
       <div class="bg-neutral-900/80 backdrop-blur-md border border-white/10 p-6 rounded-xl shadow-2xl hover:border-emerald-500/50 transition-colors group">
          <div class="flex justify-between items-start mb-2">
             <p class="text-neutral-500 text-xs font-bold uppercase tracking-widest">Socials</p>
             <IconTwitter class="w-5 h-5 text-emerald-500 opacity-50" />
          </div>
          <div class="flex gap-3 mt-1">
             {p.socials?.twitter && (
                 <a href={p.socials?.twitter} target="_blank" class="p-2 bg-neutral-800/50 hover:bg-blue-500/20 border border-neutral-700 hover:border-blue-500 rounded-lg transition-colors text-neutral-400 hover:text-blue-400">
                    <IconTwitter class="w-5 h-5" />
                  </a>
             )}
             {p.socials?.twitch && (
                 <a href={p.socials?.twitch} target="_blank" class="p-2 bg-neutral-800/50 hover:bg-purple-500/20 border border-neutral-700 hover:border-purple-500 rounded-lg transition-colors text-neutral-400 hover:text-purple-400">
                    <IconTwitch class="w-5 h-5" />
                  </a>
             )}
             {!p.socials && <span class="text-neutral-500 italic">No Comms</span>}
          </div>
       </div>

       {/* STAT 4: Next Game */}
       <div class="bg-neutral-950 border border-neutral-800 p-6 rounded-xl flex flex-col justify-center relative overflow-hidden">
          {stats.upcoming.length > 0 ? (
             <>
               <div class="absolute top-0 right-0 p-3">
                  <span class="flex h-3 w-3 relative">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                  </span>
               </div>
               <p class="text-neutral-500 text-xs font-bold uppercase tracking-widest mb-2">Next Game</p>
               <div class="text-white font-bold text-lg leading-tight line-clamp-2">
                 vs {stats.upcoming[0].match2opponents.find(op => !op.name.toLowerCase().includes(p.team.toLowerCase()))?.name || 'Opponent'}
               </div>
               <p class="text-neutral-400 text-xs mt-1">{new Date(stats.upcoming[0].date).toLocaleDateString()}</p>
             </>
          ) : (
             <div class="flex flex-col items-center justify-center text-neutral-600 h-full">
                <span class="text-xs font-bold uppercase tracking-widest">No Active Missions</span>
             </div>
          )}
       </div>

    </div>
  </div>

  {/* =========================================================================
      3. MAIN CONTENT GRID
     ========================================================================= */}
  <div class="max-w-7xl mx-auto px-6 pb-24 grid grid-cols-1 lg:grid-cols-3 gap-12">
    
    {/* LEFT COLUMN: Bio & Timeline */}
    <div class="lg:col-span-2 space-y-12">
       <div class="prose prose-invert prose-lg max-w-none">
          <h3 class="font-title text-3xl text-white mb-6 border-l-4 border-white pl-4">ABOUT {p.name}</h3>
          <Content />
       </div>

       {/* Timeline */}
       {/* SERVICE RECORD (Replaces Timeline) */}
       {p.career && p.career.length > 0 && (
         <div class="mt-12">
            <h3 class="font-title text-2xl text-white mb-6 border-b border-neutral-800 pb-2 flex items-center gap-2">
               Career Highlights
               <span class="text-xs font-mono text-neutral-500 bg-neutral-900 border border-neutral-800 px-2 py-0.5 rounded">
                  {new Set(p.career.map(c => c.team)).size} Tours
               </span>
            </h3>

            <div class="grid grid-cols-1 gap-4">
                {getDistinguishedService(p.career).map(service => {
                    const tEntry = allTeams.find(t => t.data.name === service.name);
                    const logo = tEntry?.data.logo?.replace('/upload/', '/upload/w_100,h_100,c_fit,f_auto/');
                    const isCurrent = service.years.some(y => y.toLowerCase().includes('present'));

                    return (
                        <div class={`relative overflow-hidden rounded-xl border p-5 transition-all hover:bg-neutral-900/80 ${isCurrent ? 'bg-neutral-900/60 border-amber-500/30' : 'bg-neutral-900/30 border-neutral-800'}`}>
                            {/* Background Watermark */}
                            {logo && <img src={logo} class="absolute -right-4 -bottom-4 w-24 h-24 opacity-5 grayscale rotate-12 pointer-events-none" />}
                            
                            <div class="flex items-start gap-4 relative z-10">
                                {/* Logo Box */}
                                <div class={`w-12 h-12 rounded-lg flex items-center justify-center border shadow-inner ${isCurrent ? 'bg-amber-500/10 border-amber-500/20' : 'bg-neutral-950 border-neutral-800'}`}>
                                    {logo ? <img src={logo} class="w-8 h-8 object-contain" /> : <span class="font-bold text-neutral-600">{service.name[0]}</span>}
                                </div>

                                {/* Content */}
                                <div class="flex-1">
                                    <div class="flex justify-between items-start">
                                        <h4 class={`text-lg font-bold font-title leading-none mb-1 ${isCurrent ? 'text-white' : 'text-neutral-300'}`}>
                                            {service.name}
                                        </h4>
                                        {isCurrent && <span class="text-[9px] font-bold bg-amber-500 text-black px-1.5 py-0.5 rounded tracking-wider uppercase">Active</span>}
                                    </div>
                                    
                                    {/* Accolades List */}
                                    {service.accolades.length > 0 ? (
                                        <ul class="mt-3 space-y-1.5">
                                            {service.accolades.map(note => (
                                                <li class="flex items-start gap-2 text-sm text-neutral-400">
                                                    <span class="mt-1 w-1 h-1 rounded-full bg-amber-500 shrink-0"></span>
                                                    <span>{note}</span>
                                                </li>
                                            ))}
                                        </ul>
                                    ) : (
                                        <p class="mt-2 text-xs text-neutral-600 italic">No recorded honors.</p>
                                    )}
                                </div>
                            </div>
                        </div>
                    );
                })}
            </div>
         </div>
       )}
    </div>

    {/* RIGHT COLUMN: POV & Match Log */}
    <div class="space-y-8">
       {mostRecentPovUrl && (
          <div class="bg-neutral-900 border border-neutral-800 rounded-2xl p-6 shadow-xl relative overflow-hidden">
             <div class="absolute top-0 right-0 p-4 opacity-10">
                <IconTwitch class="w-24 h-24 text-white" />
             </div>
             <h3 class="font-title text-xl text-white mb-4 flex items-center gap-2 relative z-10">
                <span class="text-red-600 animate-pulse">●</span> LATEST POV
             </h3>
             <div class="relative w-full bg-black rounded-lg overflow-hidden shadow-lg aspect-video z-10">
               <iframe src={mostRecentPovUrl} title="POV" class="absolute top-0 left-0 w-full h-full" allowfullscreen></iframe>
             </div>
             <p class="text-xs text-neutral-500 mt-3 text-center relative z-10">
                POV Courtesy of <a href="https://www.youtube.com/@ObsSojourn" class="text-white underline decoration-amber-500">@ObsSojourn!</a>
             </p>
          </div>
       )}

       {/* Match History */}
       <div>
          <h3 class="font-title text-2xl text-white mb-6 flex items-center gap-3">
             <span class="w-2 h-2 bg-amber-500 rounded-full"></span>
             RECENT MATCHES
          </h3>
          
          <div class="space-y-2">
             {stats.history.length > 0 ? stats.history.map(match => {
                const teamName = teamEntry ? teamEntry.data.name.toLowerCase() : p.team.toLowerCase();
                const isTeam1 = match.match2opponents[0].name.toLowerCase().includes(teamName);
                const isWinner = match.winner === (isTeam1 ? '1' : '2');
                
                const opponent = match.match2opponents.find(op => !op.name.toLowerCase().includes(teamName))?.name || 'Unknown';
                const s1 = match.match2opponents[0].score || 0;
                const s2 = match.match2opponents[1].score || 0;
                const scoreDisplay = isTeam1 ? `${s1} - ${s2}` : `${s2} - ${s1}`;

                return (
                  <div class="group flex items-center justify-between p-3 bg-neutral-900 border border-neutral-800 rounded-lg hover:border-neutral-600 transition-all hover:bg-neutral-800/50">
                     
                     {/* LEFT: Match Info */}
                     <div class="flex flex-col gap-0.5">
                        <span class="text-[9px] text-neutral-500 font-bold uppercase tracking-wider">
                            {match.tournament.replace('Overwatch Champions Series 2025', 'OWCS').split(' - ')[0]}
                        </span>
                        <div class="flex items-center gap-1.5">
                           <span class="text-neutral-600 font-bold text-xs">VS</span>
                           <span class="text-sm font-bold text-white group-hover:text-amber-500 transition-colors">
                              {opponent}
                           </span>
                        </div>
                     </div>

                     {/* RIGHT: The Tactical Score Pill */}
                     <div class="flex items-center gap-3">
                        {/* Date (Hidden on small screens) */}
                        <span class="text-[10px] text-neutral-600 font-mono hidden sm:block">
                           {new Date(match.date).toLocaleDateString(undefined, {month:'short', day:'numeric'})}
                        </span>

                        {/* The Badge */}
                        <div class={`flex h-8 rounded border overflow-hidden ${isWinner ? 'border-green-500/30 bg-green-500/10' : 'border-red-500/30 bg-red-500/10'}`}>
                           {/* Score Number */}
                           <div class="px-2.5 flex items-center justify-center font-mono font-bold text-white text-sm tracking-widest bg-black/20">
                              {scoreDisplay}
                           </div>
                           
                           {/* W/L Indicator */}
                           <div class={`w-8 flex items-center justify-center text-xs font-black ${isWinner ? 'bg-green-500 text-black' : 'bg-red-500 text-white'}`}>
                              {isWinner ? 'W' : 'L'}
                           </div>
                        </div>
                     </div>

                  </div>
                );
             }) : (
                <div class="p-8 text-center text-neutral-600 border border-dashed border-neutral-800 rounded bg-neutral-900/50">
                   <p class="text-sm">No recent combat data found.</p>
                </div>
             )}
          </div>
       </div>
    </div>

    {/* ==============================================
    SIMILAR PLAYERS
    ============================================== */}
    {(() => {
      const similarPlayers = allPlayers.filter(pl => pl.data.role === p.role && pl.slug !== playerEntry.slug);
      if (similarPlayers.length === 0) return null;
      const showcase = similarPlayers.sort(() => 0.5 - Math.random()).slice(0, 4);

      return (
        <div class="mt-16 border-t border-neutral-800 pt-12 col-span-full">
          <div class="flex items-center justify-between mb-8">
             <h2 class="font-title text-3xl text-white flex items-center gap-3">
               Other <span style={`color: ${teamColor};`}>{p.role}</span> Players
             </h2>
             <a href="/players" class="text-sm font-bold text-neutral-500 hover:text-white transition-colors uppercase tracking-wider">View All →</a>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">
            {showcase.map(pl => {
               const pHeadshot = pl.data.headshot?.replace('/upload/', '/upload/w_400,c_fit,b_transparent,f_auto,q_auto:best/');
               const pTeam = allTeams.find(t => t.slug === pl.data.team);
               const pColor = pTeam?.data.colour || '#525252';
               return (
                 <a href={`/players/${pl.slug}/`} class="group relative h-72 bg-neutral-900 rounded-xl border border-neutral-800 overflow-hidden hover:border-neutral-600 transition-all hover:-translate-y-1 shadow-lg" style={`--hover-color: ${pColor};`}>
                   <div class="absolute inset-0 border-2 border-transparent group-hover:border-[color:var(--hover-color)] rounded-xl transition-colors pointer-events-none z-20"></div>
                   {pHeadshot ? (
                     <img src={pHeadshot} class="absolute inset-0 w-full h-full object-cover object-top transition-transform duration-500 group-hover:scale-105" />
                   ) : <div class="absolute inset-0 bg-neutral-800"></div>}
                   <div class="absolute inset-0 bg-gradient-to-t from-black via-black/40 to-transparent opacity-90"></div>
                   <div class="absolute bottom-0 left-0 right-0 p-4">
                      <p class="text-xs font-bold uppercase tracking-wider text-neutral-400 mb-1">{pTeam?.data.name}</p>
                      <h4 class="font-title text-3xl text-white leading-none">{pl.data.name}</h4>
                   </div>
                 </a>
               )
            })}
          </div>
        </div>
      );
    })()}

  </div>

</BaseLayout>