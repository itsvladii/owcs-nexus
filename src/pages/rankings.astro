---
import BaseLayout from "../layouts/BaseLayout.astro";
import RankingsTable, { type RankingTeam } from "../components/RankTable";
import { fetchAllSeasonMatches } from "../lib/fetchMatches";
import { calculateRankings } from "../lib/calcELO";
import { getCollection } from "astro:content";

//#region
// 1. Fetch Data & Run Algo
const apiKey = import.meta.env.LIQUIPEDIA_API_KEY;
const userAgent = "OWCS-Nexus (your-email@example.com)";
const matches = await fetchAllSeasonMatches(apiKey, userAgent);
const { rankings, stats } = calculateRankings(matches);
Astro.response.headers.set(
    "Cache-Control",
    "public, max-age=0, s-maxage=3600, stale-while-revalidate",
);
// 2. Get Local Data (Partner info & Logos)
const allTeams = await getCollection("teams");

const lastUpdated = new Date().toLocaleDateString("en-US", {
    month: "long",
    day: "numeric",
    year: "numeric",
});

// Helper to find the local team entry
function getLocalTeam(apiName: string) {
    return allTeams.find(
        (t) =>
            t.data.name.toLowerCase() === apiName.toLowerCase() ||
            t.data.liquipediaName?.toLowerCase() === apiName.toLowerCase(),
    );
}

// Helper to get display properties for a team
// Now accepts the full 'team' object from the ranking list to access the API logo
function getTeamProps(team: {
    name: string;
    logo?: string;
    logoDark?: string;
}) {
    const localTeam = getLocalTeam(team.name);
    const isPartner = localTeam?.data.isPartner ?? false;
    const hasPage = !!localTeam;

    const color = localTeam?.data.colour || "#525252"; // Fallback gray

    // LOGO LOGIC: Local File (Best) -> API Logo (Good) -> Fallback (None)
    const logo = localTeam?.data.logo
        ? localTeam.data.logo.replace(
              "/upload/",
              "/upload/w_200,h_200,c_pad,f_auto,q_auto/",
          )
        : team.logoDark || team.logo;

    return { localTeam, isPartner, hasPage, color, logo };
}
//#endregion

const top3 = rankings.slice(0, 3);
const restOfThePack = rankings.slice(0, 25);

const tableData: RankingTeam[] = restOfThePack.map((team, index) => {
    const { localTeam, isPartner, hasPage, color, logo } = getTeamProps(team);
    return {
        rank: index+1,
        name: team.name,
        slug: localTeam?.slug || "",
        rating: team.rating,
        wins: team.wins,
        losses: team.losses,
        region: team.region,
        logo: logo,
        color: color,
        isPartner: isPartner,
        hasPage: hasPage,
        history: team.history, // Passing the ELO history for the graph!
    };
});
---

<BaseLayout title="Global Power Rankings" fullWidth={true}>
    {
        /* ==============================================
  HERO BACKGROUND WALLPAPER
  ============================================== */
    }
    <div class="relative w-full h-[60vh] overflow-hidden rounded-xl">
        {/* Replace src with your preferred background */}
        <img
            src="https://live.staticflickr.com/65535/53890975945_9b32cbe1ae_k.jpg"
            alt="OWCS Stage Background"
            class="w-full h-200 object-cover object-center scale-105 filter brightness-[0.6]"
        />
        {/* Gradient Overlay */}
        <div
            class="absolute inset-0 bg-gradient-to-b from-neutral-950/30 via-neutral-950/80 to-neutral-950"
        >
        </div>
    </div>

    {/* MAIN CONTENT CONTAINER (Overlapping the banner) */}
    <div class="max-w-6xl mx-auto px-4 relative z-10 -mt-64 md:-mt-80 pb-24">
        <div class="text-center mb-16 drop-shadow-2xl">
            <h1
                class="text-6xl md:text-8xl font-title text-white mb-4 tracking-tight"
            >
                GLOBAL RANKINGS
            </h1>
            <p
                class="text-neutral-300 text-lg md:text-xl max-w-2xl mx-auto font-medium"
            >
                Algorithmic power rankings based on {matches.length} matches.
                <br />
                <span class="text-neutral-500 text-sm font-normal">
                    Last updated: {lastUpdated}
                </span>
            </p>
        </div>

        {
            /* ==============================================
    1. SEASON HIGHLIGHTS (Movers & Upsets)
    ============================================== */
        }
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-24">
            {/* CARD 1: BIGGEST MOVER */}
            {
                stats.biggestMover &&
                    (() => {
                        const { logo } = getTeamProps(stats.biggestMover);
                        return (
                            <div class="bg-neutral-900/90 border border-green-900/50 p-8 rounded-2xl backdrop-blur-md relative overflow-hidden group hover:border-green-500/50 transition-all hover:-translate-y-1 shadow-lg">
                                <div class="absolute -top-4 -right-4 opacity-10 group-hover:opacity-20 transition-opacity rotate-12">
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="w-32 h-32 text-green-500"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"
                                        />
                                    </svg>
                                </div>

                                <p class="text-green-400 text-xs font-bold uppercase tracking-widest mb-4 flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse" />{" "}
                                    Biggest Mover (30d)
                                </p>

                                <div class="flex flex-col items-start">
                                    {logo && (
                                        <img
                                            src={logo}
                                            alt={stats.biggestMover.name}
                                            class="w-16 h-16 object-contain mb-3 drop-shadow-md"
                                        />
                                    )}
                                    <h3 class="text-3xl font-title text-white mb-1 leading-none line-clamp-1">
                                        {stats.biggestMover.name}
                                    </h3>
                                    <p class="text-4xl font-mono font-bold text-green-500 tracking-tight">
                                        +{Math.round(stats.biggestMover.diff)}{" "}
                                        <span class="text-base text-neutral-400 font-sans font-normal">
                                            pts
                                        </span>
                                    </p>
                                </div>
                            </div>
                        );
                    })()
            }

            {/* CARD 2: BIGGEST FALLER */}
            {
                stats.biggestLoser &&
                    (() => {
                        const { logo } = getTeamProps(stats.biggestLoser);
                        return (
                            <div class="bg-neutral-900/90 border border-red-900/50 p-8 rounded-2xl backdrop-blur-md relative overflow-hidden group hover:border-red-500/50 transition-all hover:-translate-y-1 shadow-lg">
                                <div class="absolute -top-4 -right-4 opacity-10 group-hover:opacity-20 transition-opacity -rotate-12">
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="w-32 h-32 text-red-500"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"
                                        />
                                    </svg>
                                </div>

                                <p class="text-red-400 text-xs font-bold uppercase tracking-widest mb-4 flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full bg-red-500" />{" "}
                                    Biggest Faller (30d)
                                </p>

                                <div class="flex flex-col items-start">
                                    {logo && (
                                        <img
                                            src={logo}
                                            alt={stats.biggestLoser.name}
                                            class="w-16 h-16 object-contain mb-3 drop-shadow-md grayscale opacity-80 group-hover:grayscale-0 group-hover:opacity-100 transition-all"
                                        />
                                    )}
                                    <h3 class="text-3xl font-title text-white mb-1 leading-none line-clamp-1">
                                        {stats.biggestLoser.name}
                                    </h3>
                                    <p class="text-4xl font-mono font-bold text-red-500 tracking-tight">
                                        {Math.round(stats.biggestLoser.diff)}{" "}
                                        <span class="text-base text-neutral-400 font-sans font-normal">
                                            pts
                                        </span>
                                    </p>
                                </div>
                            </div>
                        );
                    })()
            }

            {/* CARDS 3 & 4: BIGGEST UPSETS */}
            {
                stats.biggestUpsets.map((upset) => {
                    // We create temporary team objects just to look up the props
                    const winnerProps = getTeamProps({
                        name: upset.winner,
                        logo: upset.winnerLogo,
                        logoDark: upset.winnerLogoDark,
                    });
                    const loserProps = getTeamProps({
                        name: upset.loser,
                        logo: upset.loserLogo,
                        logoDark: upset.loserLogoDark,
                    });
                    return (
                        <div class="bg-neutral-900/90 border border-amber-900/30 p-8 rounded-2xl backdrop-blur-md relative overflow-hidden hover:border-amber-500/50 transition-all hover:-translate-y-1 shadow-lg flex flex-col justify-between">
                            <div>
                                <p class="text-amber-500 text-xs font-bold uppercase tracking-widest mb-6 flex items-center gap-2">
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        viewBox="0 0 24 24"
                                        fill="currentColor"
                                        class="w-4 h-4"
                                    >
                                        <path
                                            fill-rule="evenodd"
                                            d="M14.615 1.595a.75.75 0 0 1 .359.852L12.981 9.75h4.75a.75.75 0 0 1 .546 1.27l-10 11a.75.75 0 0 1-1.171-.446l1.993-7.304H4.393a.75.75 0 0 1-.546-1.27l10-11a.75.75 0 0 1 .768-.155Z"
                                            clip-rule="evenodd"
                                        />
                                    </svg>
                                    Biggest Upset
                                </p>

                                <div class="flex items-center justify-between mb-4">
                                    {/* Winner */}
                                    <div class="flex flex-col items-center gap-2 w-[40%]">
                                        {winnerProps.logo ? (
                                            <img
                                                src={winnerProps.logo}
                                                class="w-12 h-12 object-contain drop-shadow-md"
                                            />
                                        ) : (
                                            <div class="w-12 h-12 bg-neutral-800 rounded-full flex items-center justify-center text-xs font-bold text-neutral-600">
                                                {upset.winner
                                                    .substring(0, 2)
                                                    .toUpperCase()}
                                            </div>
                                        )}
                                        <span class="font-bold text-white text-sm leading-tight text-center line-clamp-2">
                                            {upset.winner}
                                        </span>
                                    </div>

                                    <span class="text-neutral-600 text-xs font-black font-mono italic">
                                        DEF.
                                    </span>

                                    {/* Loser */}
                                    <div class="flex flex-col items-center gap-2 w-[40%] opacity-60">
                                        {loserProps.logo ? (
                                            <img
                                                src={loserProps.logo}
                                                class="w-10 h-10 object-contain grayscale"
                                            />
                                        ) : (
                                            <div class="w-10 h-10 bg-neutral-800 rounded-full flex items-center justify-center text-xs font-bold text-neutral-600">
                                                {upset.loser
                                                    .substring(0, 2)
                                                    .toUpperCase()}
                                            </div>
                                        )}
                                        <span class="font-bold text-neutral-400 text-xs leading-tight text-center line-clamp-2">
                                            {upset.loser}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            {/* Tournament Name (With Wrap Fix) */}
                            <div class="mt-2 pt-4 border-t border-white/5">
                                <div class="flex justify-between items-end">
                                    <span class="text-xs text-neutral-500 leading-tight pr-4 block">
                                        {upset.tournament}
                                    </span>
                                    <span class="text-amber-500 font-bold font-mono text-xl shrink-0">
                                        {(upset.prob * 100).toFixed(1)}%
                                    </span>
                                </div>
                                <div class="w-full bg-neutral-800 h-1.5 rounded-full mt-2 overflow-hidden">
                                    <div
                                        class="bg-amber-500 h-full"
                                        style={`width: ${upset.prob * 100}%`}
                                    />
                                </div>
                            </div>
                        </div>
                    );
                })
            }
        </div>

        {
            /* ==============================================
    2. THE PODIUM (Top 3) - UPDATED WITH STATS
    ============================================== */
        }


        <div
            class="bg-neutral-900/90 border border-neutral-800 rounded-xl overflow-hidden shadow-2xl backdrop-blur-sm"
        >

            {/* Rows */}
            <RankingsTable teams={tableData} client:load />
            <p class="text-center text-neutral-600 text-sm mt-8">
            * Click on any team to see detailed stats and history.
            </p>
        </div>

        <div class="mt-24 border-t border-neutral-800 pt-12">
            <h2
                class="text-3xl font-bold text-white font-title mb-8 text-center"
            >
                How It Works
            </h2>

            <div
                class="grid grid-cols-1 md:grid-cols-2 gap-12 text-neutral-400 leading-relaxed"
            >
                {/* Column 1: The Basics */}
                <div>
                    <h3
                        class="text-xl font-bold font-title text-white font-title mb-4 flex items-center gap-2"
                    >
                        <span class="text-amber-500">01.</span> The System
                    </h3>
                    <p class="mb-4">
                        The <strong
                            >OWCS Nexus Global Power Rankings (GLP)</strong
                        > uses a custom ELO algorithm similar to the one used in
                        Chess or in other professional sports (like the FIFA Man's
                        World Rankings). Every team starts with a base rating based
                        on their region, and points are transferred from the loser
                        to the winner after every match.
                    </p>
                    <ul class="list-disc list-inside space-y-2 ml-2">
                        <li>
                            Wins increase the rating, while losses decrease it.
                        </li>
                        <li>
                            Beating a higher-rated team grants <strong
                                >more points, and viceversa</strong
                            > (an upset).
                        </li>
                        <li>
                            Losing to a higher-rated team loses <strong
                                >fewer points, and viceversa</strong
                            > (expected result).
                        </li>
                    </ul>
                </div>

                {/* Column 2: The Weights */}
                <div>
                    <h3
                        class="text-xl font-bold font-title text-white mb-4 flex items-center gap-2"
                    >
                        <span class="text-amber-500">02.</span> When the lights are
                        at their brightest...
                    </h3>
                    <p class="mb-4">
                        Not all matches are created equal. We use a dynamic <strong
                            >Tournament Weight</strong
                        > system to make matches on the biggest stages count more.
                    </p>

                    <div
                        class="bg-neutral-900 border border-neutral-800 rounded-lg p-4 text-sm font-mono"
                    >
                        <div
                            class="flex justify-between mb-2 border-b border-neutral-800 pb-2"
                        >
                            <span>World Finals</span>
                            <span class="text-amber-500 font-bold"
                                >2.5x Impact</span
                            >
                        </div>
                        <div
                            class="flex justify-between mb-2 border-b border-neutral-800 pb-2"
                        >
                            <span>Midseason Majors</span>
                            <span class="text-amber-500 font-bold"
                                >2.0x Impact</span
                            >
                        </div>
                        <div
                            class="flex justify-between mb-2 border-b border-neutral-800 pb-2"
                        >
                            <span>International Majors</span>
                            <span class="text-amber-500 font-bold"
                                >1.5x Impact</span
                            >
                        </div>
                        <div class="flex justify-between">
                            <span>Regional Regular Season (Stages)</span>
                            <span class="text-neutral-500">1.0x Impact</span>
                        </div>
                    </div>
                </div>

                {/* Column 3: Regional Seeding */}
                <div
                    class="md:col-span-2 bg-neutral-900/50 border border-neutral-800 rounded-xl p-8"
                >
                    <h3
                        class="text-xl font-bold font-title text-white mb-4 flex items-center gap-2"
                    >
                        <span class="text-amber-500">03.</span> Regional Seeding
                    </h3>
                    <p class="mb-6">
                        To account for the strength disparity between regions,
                        teams do not start at 0. They are seeded based on the
                        historical strength of their region, that is going to
                        change every 2 years based on the results of the region
                        in international tournaments. This means a 5-0 record in <strong
                            >Korea (OWCS Asia)</strong
                        > during the Regular Season is mathematically valued higher
                        than a 5-0 record in a developing region.
                    </p>
                    <div
                        class="bg-neutral-900 border border-neutral-800 rounded-lg p-4 text-sm font-mono"
                    >
                        <div
                            class="flex justify-between mb-2 border-b border-neutral-800 pb-2"
                        >
                            <span>Korea</span>
                            <span class="text-amber-500 font-bold">1350</span>
                        </div>
                        <div
                            class="flex justify-between mb-2 border-b border-neutral-800 pb-2"
                        >
                            <span>EMEA and NA</span>
                            <span class="text-amber-500 font-bold">1250</span>
                        </div>
                        <div
                            class="flex justify-between mb-2 border-b border-neutral-800 pb-2"
                        >
                            <span>China</span>
                            <span class="text-amber-500 font-bold">1200</span>
                        </div>
                        <div
                            class="flex justify-between mb-2 border-b border-neutral-800 pb-2"
                        >
                            <span>Japan</span>
                            <span class="text-amber-500 font-bold">1150</span>
                        </div>
                        <div
                            class="flex justify-between mb-2 border-b border-neutral-800 pb-2"
                        >
                            <span>Pacific/Rest of the World</span>
                            <span class="text-amber-500 font-bold">1100</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</BaseLayout>
