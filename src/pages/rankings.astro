---
import BaseLayout from "../layouts/BaseLayout.astro";
import RankingsTable, { type RankingTeam } from "../components/eloComps/RankTable";
import GPRExpl from "../components/eloComps/GPRExpl.astro";
import { fetchAllSeasonMatches } from "../lib/stats/fetchMatches";
import { calculateRankings } from "../lib/elo/calcELO";
import { getCollection } from "astro:content";

//#region
// 1. Fetch Data & Run Algo
const apiKey = import.meta.env.LIQUIPEDIA_API_KEY;
const userAgent = "OWCS-Nexus (barcanvladi@gmail.com)";
const matches = await fetchAllSeasonMatches(apiKey, userAgent);
const { rankings, stats } = calculateRankings(matches);
Astro.response.headers.set(
    "Cache-Control",
    "public, max-age=0, s-maxage=3600, stale-while-revalidate",
);
// 2. Get Local Data (Partner info & Logos)
const allTeams = await getCollection("teams");

const lastUpdated = new Date().toLocaleDateString("en-US", {
    month: "long",
    day: "numeric",
    year: "numeric",
});

// Helper to find the local team entry
function getLocalTeam(apiName: string) {
    return allTeams.find(
        (t) =>
            t.data.name.toLowerCase() === apiName.toLowerCase() ||
            t.data.liquipediaName?.toLowerCase() === apiName.toLowerCase(),
    );
}

// Helper to get display properties for a team
// Now accepts the full 'team' object from the ranking list to access the API logo
function getTeamProps(team: {
    name: string;
    logo?: string;
    logoDark?: string;
}) {
    const localTeam = getLocalTeam(team.name);
    const isPartner = localTeam?.data.isPartner ?? false;
    const hasPage = !!localTeam;

    const color = localTeam?.data.colour || "#525252"; // Fallback gray

    // LOGO LOGIC: Local File (Best) -> API Logo (Good) -> Fallback (None)
    const logo = localTeam?.data.logo
        ? localTeam.data.logo.replace(
              "/upload/",
              "/upload/w_200,h_200,c_pad,f_auto,q_auto/",
          )
        : team.logoDark || team.logo;

    return { localTeam, isPartner, hasPage, color, logo };
}
//#endregion

const restOfThePack = rankings.slice(0, 30);

const tableData: RankingTeam[] = restOfThePack.map((team, index) => {
    const { localTeam, isPartner, hasPage, color, logo } = getTeamProps(team);
    return {
        rank: index + 1,
        name: team.name,
        slug: localTeam?.slug || "",
        rating: team.rating,
        wins: team.wins,
        losses: team.losses,
        region: team.region,
        logo: logo,
        color: color,
        isPartner: isPartner,
        hasPage: hasPage,
        history: team.history, // Passing the ELO history for the graph!
        rankDelta: team.rankDelta,
        tournaments: team.tournaments,
        form: team.form
    };
});
---

<BaseLayout title="Global Power Rankings" fullWidth={true}>
    {
        /* ==============================================
  HERO BACKGROUND WALLPAPER
  ============================================== */
    }
    <div class="relative w-full h-[60vh] overflow-hidden rounded-xl">
        {/* Replace src with your preferred background */}
        <img
            src="https://live.staticflickr.com/65535/54957111419_8fbc5e3e0f_k.jpg"
            alt="OWCS Stage Background"
            class="w-full h-200 object-cover object-center scale-105 filter brightness-[0.6]"
        />
        {/* Gradient Overlay */}
        <div
            class="absolute inset-0 bg-gradient-to-b from-neutral-950/30 via-neutral-950/80 to-neutral-950"
        >
        </div>
    </div>

    {/* MAIN CONTENT CONTAINER (Overlapping the banner) */}
    <div class="max-w-6xl mx-auto px-4 relative z-10 -mt-64 md:-mt-80 pb-24">
        <div class="text-center mb-16 drop-shadow-2xl">
            <h1
                class="text-6xl md:text-8xl font-title text-white mb-4 tracking-tight"
            >
                GLOBAL RANKINGS
            </h1>
            <p
                class="text-neutral-300 text-lg md:text-xl max-w-2xl mx-auto font-medium"
            >
                Algorithmic power rankings based on {matches.length} matches.
                <br />
                <span class="text-neutral-500 text-sm font-normal">
                    Last updated: {lastUpdated}
                </span>
            </p>
        </div>


        {
            /* ==============================================
    1. SEASON HIGHLIGHTS (Movers & Upsets)
    ============================================== */
        }
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-24">
            {/* CARD 1: BIGGEST MOVER */}
            {
                stats.biggestMover &&
                    (() => {
                        const { logo } = getTeamProps(stats.biggestMover);
                        return (
                            <div class="bg-neutral-900/90 border border-green-900/50 p-8 rounded-2xl backdrop-blur-md relative overflow-hidden group hover:border-green-500/50 transition-all hover:-translate-y-1 shadow-lg">
                                <div class="absolute -top-4 -right-4 opacity-10 group-hover:opacity-20 transition-opacity rotate-12">
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="w-32 h-32 text-green-500"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"
                                        />
                                    </svg>
                                </div>

                                <p class="text-green-400 text-xs font-bold uppercase tracking-widest mb-4 flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse" />{" "}
                                    Biggest Mover (30d)
                                </p>

                                <div class="flex flex-col items-start">
                                    {logo && (
                                        <img
                                            src={logo}
                                            alt={stats.biggestMover.name}
                                            class="w-16 h-16 object-contain mb-3 drop-shadow-md"
                                        />
                                    )}
                                    <h3 class="text-3xl font-title text-white mb-1 leading-none line-clamp-1">
                                        {stats.biggestMover.name}
                                    </h3>
                                    <p class="text-4xl font-mono font-bold text-green-500 tracking-tight">
                                        +{Math.round(stats.biggestMover.diff)}{" "}
                                        <span class="text-base text-neutral-400 font-sans font-normal">
                                            pts
                                        </span>
                                    </p>
                                </div>
                            </div>
                        );
                    })()
            }

            {/* CARD 2: LONGEST REIGN */}
            {
                stats.longestReign &&
                    (() => {
                        // 1. Get the team logo/color using your existing helper
                        const { logo } = getTeamProps({
                            name: stats.longestReign.name,
                        });

                        return (
                            <div class="bg-neutral-900/90 border border-purple-900/50 p-8 rounded-2xl backdrop-blur-md relative overflow-hidden group hover:border-purple-500/30 transition-all hover:-translate-y-1 shadow-lg flex flex-col items-center text-center">
                                <div class="absolute -top-6 -right-6 opacity-5 group-hover:opacity-10 transition-opacity rotate-12">
                                    {/* Crown Icon */}
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-40 h-40 text-purple-500" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M11.7 2.805a.75.75 0 0 1 .6 0A16.035 16.035 0 0 1 16.75 5.75l.875 2.625 3.257-1.63a.75.75 0 0 1 1.034.906l-2.125 8.5a.75.75 0 0 1-.728.568h-14.126a.75.75 0 0 1-.728-.568l-2.125-8.5a.75.75 0 0 1 1.034-.906l3.257 1.629.875-2.625A16.035 16.035 0 0 1 11.7 2.805Z" />
                                    </svg>
                                </div>
                                <p class="text-purple-500 text-xs font-bold uppercase tracking-widest mb-6 flex items-center gap-2 z-10">
                                    <span class="w-2 h-2 rounded-full bg-purple-500 animate-pulse" />{" "}
                                    Longest Reign
                                </p>
                                {logo && (
                                    <img
                                        src={logo}
                                        alt={stats.longestReign.name}
                                        class="w-16 h-16 object-contain mb-4 drop-shadow-md relative z-10"
                                    />
                                )}
                                <h3 class="text-2xl font-title text-white mb-2 leading-none line-clamp-1 relative z-10">
                                    {stats.longestReign.name}
                                </h3>
                                <p class="text-4xl font-mono font-bold text-purple-500 tracking-tight relative z-10">
                                    {stats.longestReign.days}{" "}
                                    <span class="text-base text-neutral-400 font-sans font-normal">
                                        Days
                                    </span>
                                </p>
                            </div>
                        );
                    })()
            }

            {/* CARDS 3 & 4: BIGGEST UPSETS */}
            {
                stats.biggestUpsets.map((upset) => {
                    // We create temporary team objects just to look up the props
                    const winnerProps = getTeamProps({
                        name: upset.winner,
                        logo: upset.winnerLogo,
                        logoDark: upset.winnerLogoDark,
                    });
                    const loserProps = getTeamProps({
                        name: upset.loser,
                        logo: upset.loserLogo,
                        logoDark: upset.loserLogoDark,
                    });
                    return (
                        <div class="bg-neutral-900/90 border border-red-900/50 p-8 rounded-2xl backdrop-blur-md relative overflow-hidden group hover:border-red-500/30 transition-all hover:-translate-y-1 shadow-lg flex flex-col items-center text-center">
                            <div class="absolute -top-6 -right-6 opacity-5 group-hover:opacity-10 transition-opacity rotate-12">
                                {/* Lightning Icon */}
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="w-40 h-40 text-red-500"
                                    viewBox="0 0 24 24"
                                    fill="currentColor"
                                >
                                    <path
                                        fill-rule="evenodd"
                                        d="M14.615 1.595a.75.75 0 0 1 .359.852L12.982 9.75h7.268a.75.75 0 0 1 .548 1.262l-10.5 11.25a.75.75 0 0 1-1.272-.71l1.992-7.302H3.75a.75.75 0 0 1-.548-1.262l10.5-11.25a.75.75 0 0 1 .913-.143Z"
                                        clip-rule="evenodd"
                                    />
                                </svg>
                            </div>
                            <p class="text-red-500 text-xs font-bold uppercase tracking-widest mb-6 flex items-center gap-2 z-10">
                                <span class="text-lg">âš¡</span> Biggest Upset
                            </p>
                            <div class="flex items-center gap-4 mb-4 relative z-10">
                                {upset.winnerLogo ? (
                                    <img
                                        src={upset.winnerLogo}
                                        class="w-12 h-12 object-contain"
                                    />
                                ) : (
                                    <span class="text-white font-bold">
                                        {upset.winner}
                                    </span>
                                )}
                                <span class="text-neutral-500 text-xs font-bold uppercase">
                                    DEF.
                                </span>
                                {upset.loserLogo ? (
                                    <img
                                        src={upset.loserLogo}
                                        class="w-8 h-8 object-contain opacity-50 grayscale"
                                    />
                                ) : (
                                    <span class="text-neutral-500 text-xs">
                                        {upset.loser}
                                    </span>
                                )}
                            </div>

                            {/* Tournament Name (With Wrap Fix) */}
                            <div class="mt-2 pt-4 border-t border-white/5">
                                <div class="flex justify-between items-end">
                                    <span class="text-xs text-neutral-500 leading-tight pr-4 block">
                                        {upset.tournament}
                                    </span>
                                    <span class="text-red-500 font-bold font-mono text-xl shrink-0">
                                        {(upset.prob * 100).toFixed(1)}%
                                    </span>
                                </div>
                                <div class="w-full bg-neutral-800 h-1.5 rounded-full mt-2 overflow-hidden">
                                    <div
                                        class="bg-red-500 h-full"
                                        style={`width: ${upset.prob * 100}%`}
                                    />
                                </div>
                            </div>
                        </div>
                    );
                })
            }
        </div>

    

        {
            /* ==============================================
    2. THE PODIUM (Top 3) - UPDATED WITH STATS
    ============================================== */
        }

        <div
            class="bg-neutral-900/90 border border-neutral-800 rounded-xl overflow-hidden shadow-2xl backdrop-blur-sm"
        >
            {/* Rows */}
            <RankingsTable teams={tableData} client:only="react" />
            <p class="text-center text-neutral-600 text-sm mt-8">
                * Click on any team to see detailed stats and history.
            </p>
        </div>

        <div class="mt-24 border-t border-neutral-800 pt-12">
            <GPRExpl />
        </div>
    </div>
</BaseLayout>
