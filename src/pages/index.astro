---
// src/pages/index.astro
import { Image } from 'astro:assets';
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import '../styles/global.css'

const allPlayers = await getCollection('players');
const featuredPlayers = allPlayers
  .filter(player => player.data.isFeatured)
  .slice(0, 4);

const allTeams = await getCollection('teams');

// We use .reduce() to create an object where keys are regions
// and values are arrays of teams.
const teamsByRegion = allTeams.reduce((acc, team) => {
  const region = team.data.region; // e.g., 'NA', 'EMEA', 'Asia'
  
  // If this region isn't an array in our object yet, create it
  if (!acc[region]) {
    acc[region] = [];
  }
  
  // Add the current team to its region's array
  acc[region].push(team);
  return acc;
}, {});
---

<BaseLayout title="Home">
  <div class="text-center max-w-7xl mx-auto px-4">
    
    {/*div con i png dei giocatori nella homepage */}
    <div class="relative mb-24">
      
      <div class="flex justify-center items-end -space-x-12">
        {featuredPlayers.map((player, index) => {
          
          const headshotUrl = player.data.headshot
            ? player.data.headshot.replace('/upload/', '/upload/c_fit,b_transparent,f_auto,q_auto:best/')
            : null;
          
          const zIndex = 4 - index;

          return (
            <a 
              href={`/players/${player.slug}/`} 
              class="
                relative block w-72 h-96  
                transition-transform duration-300 ease-in-out hover:-translate-y-2
              "
              style={`z-index: ${zIndex};`}
              title={`View ${player.data.name}`}
            >
              {/* THE ANGLED FRAME */}
              <div class="
                relative h-full w-full 
                overflow-hidden -skew-y-3 
                shadow-[0_0_0_2px_rgba(245,158,11,0.4)] /* Using the amber shadow */
                hover:shadow-[0_0_0_3px_rgba(245,158,11,0.6)]
                transition-shadow duration-300
                bg-neutral-900/50
              ">
                {/* THE PLAYER IMAGE */}
                {headshotUrl && (
                  <img 
                    src={headshotUrl} 
                    alt={player.data.name}
                    class="
                      relative w-full h-full 
                      object-contain /* <-- CHANGED from object-cover */ 
                      skew-y-3 /* <-- REMOVED scale-125 & object-top */
                    "
                    width="600"
                    height="840" 
                  />
                )}
              </div>
            </a>
          );
        })}
      </div>
    </div>

   <h2 class="text-4xl font-bold text-white mb-8 font-title">
      All Featured Teams
    </h2>
    
    {/* We use Object.entries to loop over our new 'teamsByRegion' object */}
    {Object.entries(teamsByRegion).map(([region, teamsInRegion]) => (
      <div class="mb-12">
        {/* 1. Add a heading for the region */}
        <h3 class="text-3xl font-bold text-white mb-6 font-title text-left">
          {region}
        </h3>
        
        {/* 2. Create a grid *just* for this region's teams */}
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
          {teamsInRegion.map(team => {
            const logoUrl = team.data.logo
              ? team.data.logo.replace('/upload/', '/upload/w_200,h_200,c_pad,f_auto,q_auto/')
              : null;
            
            return (
              <a 
                href={`/teams/${team.slug}/`} 
                class="bg-neutral-900 rounded-lg p-6 border border-gray-800 transition-all duration-300 hover:border-gray-700 hover:scale-105 flex flex-col justify-center items-center h-48"
              >
                {logoUrl && (
                  <img 
                    src={logoUrl} 
                    alt={`${team.data.name} Logo`}
                    class="w-24 h-24 object-contain"
                    width="200"
                    height="200"
                    loading="lazy"
                  />
                )}
                <h3 class="text-xl font-semibold text-white mt-4">{team.data.name}</h3>
              </a>
            );
          })}
        </div>
      </div>
    ))}

  </div>
</BaseLayout>