---
// src/pages/index.astro
export const prerender = false;

import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const allTeams = await getCollection("teams");
const teamsByRegion = allTeams.reduce((acc, team) => {
  const region = team.data.region;
  if (!acc[region]) {
    acc[region] = [];
  }
  acc[region].push(team);
  return acc;
}, {});

// 1. Get your Cloudinary cloud name from the logo URL.
// e.g., "https://res.cloudinary.com/dm1bfprgq/image/upload/..."
const cloudName = allTeams[0].data.logo.split("/")[3];
const heroClipIDs = [
  "crazy_raccoons_clip",
  "wbg_clip",
  "varrel_clip",
  "vp_clip",
  "aq_clip",
  "ntmp_clip",
  "tm_clip",
  "t1_clip",
];

// 2. Build the *correct* video base URL
const videoBaseUrl = `https://res.cloudinary.com/${cloudName}/video/upload/f_auto,q_auto:good,w_1280,br_1.5m/v1763230992`;

const heroClipUrls = heroClipIDs.map((id) => {
  // We'll use the format that we know works!
  return `${videoBaseUrl}/${id}.mp4`;
});
---

<BaseLayout title="Home">
  <div class="max-w-7xl mx-auto px-4">
    <div
      class="relative h-[600px] w-full rounded-lg overflow-hidden
             flex justify-center items-center text-center
             bg-neutral-900 mb-24 shadow-xl"
    >
      <video
        id="hero-video"
        data-clips={JSON.stringify(heroClipUrls)}
        class="absolute z-0 w-full h-full object-cover"
        autoplay
        loop
        muted
        playsinline
      >
        Your browser does not support the video tag.
      </video>

      <div class="absolute inset-0 bg-black/40 z-10"></div>

      <div class="relative z-20 p-8">
        <h1
          class="text-7xl md:text-8xl font-bold text-white font-title"
          style="text-shadow: 2px 2px 8px rgba(0,0,0,0.7);"
        >
          OWCS Nexus
        </h1>
        <p
          class="text-2xl md:text-3xl text-neutral-200 mt-2"
          style="text-shadow: 1px 1px 4px rgba(0,0,0,0.5);"
        >
          All of OWCS, right at your fingertips.
        </p>
      </div>
    </div>

    <div class="mb-24 -mt-12 relative z-20">
      {/* -mt-12 pulls it up slightly over the video */}
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <a
          href="#featured-teams"
          class="block p-8 bg-neutral-900
            border border-neutral-800 rounded-lg
            transition-all duration-300
            hover:border-amber-500/50 hover:scale-[1.02]
            shadow-lg"
        >
          <h3 class="font-title text-3xl font-bold text-white">
            Know Your Teams
          </h3>
          <p class="text-lg text-neutral-400 mt-2 mb-4">
            Browse all the official partner teams of the OWCS and some notable
            mentions, sorted by region.
          </p>
          <span class="font-bold text-amber-500"> Scroll to Teams &rarr; </span>
        </a>

        <a
          href="/compare"
          class="block p-8 bg-neutral-900
            border border-neutral-800 rounded-lg
            transition-all duration-300
            hover:border-amber-500/50 hover:scale-[1.02]
            shadow-lg"
        >
          <h3 class="font-title text-3xl font-bold text-white">
            Player Comparison
          </h3>
          <p class="text-lg text-neutral-400 mt-2 mb-4">
            Want to start some discussions? Compare two players to see who has the most trophies in their cabinet.
          </p>
          <span class="font-bold text-amber-500"> Browse Players &rarr; </span>
        </a>
      </div>
      <br>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <a
          href="/rankings"
          class="block p-8 bg-neutral-900
            border border-neutral-800 rounded-lg
            transition-all duration-300
            hover:border-amber-500/50 hover:scale-[1.02]
            shadow-lg"
        >
          <h3 class="font-title text-3xl font-bold text-white">
            Team Power Rankings
          </h3>
          <p class="text-lg text-neutral-400 mt-2 mb-4">
            (Un)official power rankings of the featured teams. Who's the apex predator of the moment?
          </p>
          <span class="font-bold text-amber-500"> Go to Power Rankings &rarr; </span>
        </a>

        <a
          href="/players"
          class="block p-8 bg-neutral-900
            border border-neutral-800 rounded-lg
            transition-all duration-300
            hover:border-amber-500/50 hover:scale-[1.02]
            shadow-lg"
        >
          <h3 class="font-title text-3xl font-bold text-white">
            Find a Player
          </h3>
          <p class="text-lg text-neutral-400 mt-2 mb-4">
            Want to know more about a specific player? Check the complete
            database of players!
          </p>
          <span class="font-bold text-amber-500"> Browse Players &rarr; </span>
        </a>
      </div>
    </div>

    <h2 id="featured-teams" class="text-5xl font-bold text-white mb-12 font-title text-center tracking-wide">
      ALL FEATURED TEAMS
    </h2>
    
    <div class="space-y-16"> {/* Spacing between regions */}
      
      {Object.entries(teamsByRegion).map(([region, teamsInRegion]) => (
        <div class="relative">
          
          {/* 1. Stylish Region Header with a Line */}
          <div class="flex items-center gap-4 mb-6">
            <h3 class="text-3xl font-bold text-amber-500 font-title uppercase tracking-wider">
              {region}
            </h3>
            <div class="h-px bg-gradient-to-r from-amber-500/50 to-transparent flex-1"></div>
          </div>
          
          {/* 2. The Grid */}
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {teamsInRegion.map(team => {
              const logoUrl = team.data.logo
                ? team.data.logo.replace('/upload/', '/upload/w_300,h_300,c_pad,f_auto,q_auto/')
                : null;
              
              return (
                <a 
                  href={`/teams/${team.slug}/`} 
                  class="
                    group relative block 
                    bg-neutral-900/80 backdrop-blur-sm
                    border border-neutral-800 
                    rounded-xl overflow-hidden
                    transition-all duration-300
                    hover:border-amber-500/50 hover:-translate-y-1 hover:shadow-[0_0_30px_-10px_rgba(245,158,11,0.3)]
                  "
                >
                  {/* Hover Gradient Background */}
                  <div class="
                    absolute inset-0 
                    bg-gradient-to-t from-amber-900/20 to-transparent 
                    opacity-0 group-hover:opacity-100 transition-opacity duration-500
                  "></div>

                  <div class="relative z-10 p-8 flex flex-col items-center">
                    
                    {/* Logo with Glow Effect */}
                    <div class="relative mb-6">
                      {/* Glow behind logo */}
                      <div class="absolute inset-0 bg-white/10 blur-2xl rounded-full scale-0 group-hover:scale-150 transition-transform duration-500"></div>
                      
                      {logoUrl && (
                        <img 
                          src={logoUrl} 
                          alt={`${team.data.name} Logo`}
                          class="
                            w-32 h-32 object-contain relative z-10 
                            drop-shadow-lg 
                            transition-transform duration-300 group-hover:scale-110
                          "
                          loading="lazy"
                        />
                      )}
                    </div>

                    {/* Team Name */}
                    <h3 class="text-3xl font-bold text-white font-title tracking-wide group-hover:text-amber-400 transition-colors">
                      {team.data.name}
                    </h3>
                    
                    {/* Optional: 'View Team' text that appears on hover */}
                    <p class="text-sm text-neutral-500 mt-2 opacity-0 transform translate-y-2 group-hover:opacity-100 group-hover:translate-y-0 transition-all duration-300">
                      View Roster &rarr;
                    </p>
                  </div>
                </a>
              );
            })}
          </div>
        </div>
      ))}
    </div>
  </div>
</BaseLayout>

<script>
  function startVideoRotation() {
    const video = document.getElementById("hero-video");
    if (!video || typeof (video as HTMLVideoElement).play !== "function") {
      return;
    }

    const videoPlayer = video as HTMLVideoElement;

    // 1. Get the list of clips from the data attribute
    const clips = JSON.parse(videoPlayer.dataset.clips || "[]");

    if (clips.length === 0) return; // Do nothing if no clips

    let currentClipIndex = -1; // Keep track of the last clip

    function playRandomClip() {
      let nextIndex = currentClipIndex;
      // 2. Pick a new clip, but make sure it's not the same one as last time
      while (nextIndex === currentClipIndex && clips.length > 1) {
        nextIndex = Math.floor(Math.random() * clips.length);
      }
      currentClipIndex = nextIndex;

      // 3. Set the new video source and load it
      videoPlayer.src = clips[currentClipIndex];
      videoPlayer.load();

      // 4. Play the video
      const playPromise = videoPlayer.play();
      if (playPromise !== undefined) {
        playPromise.catch((error) => {
          console.warn("Browser blocked video autoplay:", error);
        });
      }
    }

    // 5. When the video ends, play a new random one
    videoPlayer.addEventListener("ended", playRandomClip);

    // 6. Play the *first* random clip on page load
    playRandomClip();
  }

  // 7. This still handles the "back button" issue
  document.addEventListener("astro:page-load", startVideoRotation);
</script>
