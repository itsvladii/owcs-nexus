---
// src/pages/index.astro
export const prerender = false;

import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import DropsCard from '../components/DropsCard.tsx';
import { calculateRankings } from "../lib/calcELO";
import { fetchAllSeasonMatches } from "../lib/fetchMatches";

const apiKey = import.meta.env.LIQUIPEDIA_API_KEY;
const userAgent = 'OWCS-Nexus (barcanvladi@gmail.com)';
const matches = await fetchAllSeasonMatches(apiKey, userAgent);
const { rankings } = calculateRankings(matches);
// Get Top 5 for the preview widget
const top5 = rankings.slice(0, 5);

const allTeams = await getCollection("teams");
const teamsByRegion = allTeams.reduce((acc, team) => {
  const region = team.data.region;
  if (!acc[region]) {
    acc[region] = [];
  }
  acc[region].push(team);
  return acc;
}, {});

// 1. Get your Cloudinary cloud name from the logo URL.
// e.g., "https://res.cloudinary.com/dm1bfprgq/image/upload/..."
const cloudName = allTeams[0].data.logo.split("/")[3];
const heroClipIDs = [
  "crazy_raccoons_clip",
  "wbg_clip",
  "varrel_clip",
  "vp_clip",
  "aq_clip",
  "ntmp_clip",
  "tm_clip",
  "t1_clip",
  "tl_clip",
  "agg_clip",
  "cc_clip",
  "gk_clip",
];

// 2. Build the *correct* video base URL
const videoBaseUrl = `https://res.cloudinary.com/${cloudName}/video/upload/f_auto,q_auto:good,w_1280,br_1.5m/v1763230992`;

const heroClipUrls = heroClipIDs.map((id) => {
  // We'll use the format that we know works!
  return `${videoBaseUrl}/${id}.mp4`;
});

function getTeamLogo(name: string) {
  const local = allTeams.find(t => t.data.name === name);
  return local?.data.logo?.replace('/upload/', '/upload/w_64,h_64,c_pad,f_auto,q_auto/') || null;
}

const PLAYER_SECTION_IMG = "https://live.staticflickr.com/65535/53888289946_ca9b058f28_k.jpg";
const TEAM_SECTION_IMG = "https://live.staticflickr.com/65535/54692531031_150e8b42ef_k.jpg";
---

<BaseLayout title="Home">
  <div class="max-w-7xl mx-auto px-4">
    <div
      class="relative h-[600px] w-full rounded-lg overflow-hidden
             flex justify-center items-center text-center
             bg-neutral-900 mb-24 shadow-xl"
    >
      <video
        id="hero-video"
        data-clips={JSON.stringify(heroClipUrls)}
        class="absolute z-0 w-full h-full object-cover"
        autoplay
        loop
        muted
        playsinline
      >
        Your browser does not support the video tag.
      </video>

      <div class="absolute inset-0 bg-black/40 z-10"></div>

      <div class="relative z-20 p-8">
        <h1
          class="text-7xl md:text-8xl font-bold text-white font-title"
          style="text-shadow: 2px 2px 8px rgba(0,0,0,0.7);"
        >
          OWCS Nexus
        </h1>
        <p
          class="text-2xl md:text-3xl text-neutral-200 mt-2"
          style="text-shadow: 1px 1px 4px rgba(0,0,0,0.5);"
        >
          All of OWCS, right at your fingertips.
        </p>
      </div>
    </div>

     <DropsCard client:load />


  <section class="py-24 bg-neutral-950 relative overflow-hidden border-t border-neutral-900">
    <div class="max-w-7xl mx-auto px-4 grid grid-cols-1 lg:grid-cols-2 gap-16 items-center">
      
      {/* TEXT BLOCK */}
      <div>
        <h2 class="text-amber-500 font-bold tracking-widest uppercase mb-4 text-sm flex items-center gap-2">
            <span class="w-8 h-px bg-amber-500"></span> Live Leaderboard
        </h2>
        <h3 class="text-5xl md:text-6xl font-title text-white mb-6 leading-none">Global Power Rankings</h3>
        <p class="text-neutral-400 text-lg mb-10 leading-relaxed max-w-xl">
          Data doesn't lie. Our algorithmic ELO system tracks every official OWCS match in real-time to determine the true hierarchy of the global scene. Who's going to be the apex predator?
        </p>
        <a href="/rankings" class="inline-flex items-center gap-3 px-8 py-4 bg-amber-500 hover:bg-amber-400 text-black font-black font-title text-xl rounded transition-transform hover:translate-x-1">
          View Full Standings <span>→</span>
        </a>
      </div>

      {/* PREVIEW WIDGET */}
      <div class="bg-neutral-900/50 border border-neutral-800/50 rounded-2xl overflow-hidden shadow-2xl backdrop-blur-sm relative">
        {/* Header */}
        <div class="p-4 border-b border-neutral-800 bg-neutral-950/50 flex justify-between items-center">
            <span class="text-neutral-500 font-bold text-xs uppercase">Current Top 5</span>
            <span class="text-amber-500 text-xs animate-pulse">● Live Updates</span>
        </div>
        {/* List */}
        {top5.map((team, i) => {
           const logo = getTeamLogo(team.name);
           return (
             <div class="flex items-center justify-between p-4 border-b border-neutral-800/50 last:border-0">
               <div class="flex items-center gap-4">
                 <span class={`font-title text-2xl w-8 text-center ${i === 0 ? 'text-amber-500' : 'text-neutral-500'}`}>#{i + 1}</span>
                 {logo ? <img src={logo} class="w-10 h-10 object-contain" /> : <div class="w-10 h-10 bg-neutral-800 rounded-full"></div>}
                 <span class="font-bold text-xl text-white">{team.name}</span>
               </div>
               <span class="font-mono font-bold text-neutral-400">{Math.round(team.rating)}</span>
             </div>
           )
        })}
      </div>

    </div>
  </section>


  {/* ==============================================
  ROW 2: THE PLAYERS (Text Left / Image Right)
  ============================================== */}
  <section class="py-20 bg-neutral-900 relative overflow-hidden rounded-xl">
    
    {/* WIDER CONTAINER */}
    <div class="w-full px-6 md:px-16 lg:px-32 grid grid-cols-1 lg:grid-cols-2 gap-16 xl:gap-32 items-center">
      
      {/* TEXT BLOCK */}
      <div class="order-1">
        <h2 class="text-blue-400 font-bold tracking-widest uppercase mb-4 text-sm flex items-center gap-2">
            <span class="w-8 h-px bg-blue-400"></span> The Talent
        </h2>
        <h3 class="text-5xl md:text-7xl font-title text-white mb-6 leading-none">Meet the Pros</h3>
        <p class="text-neutral-400 text-xl mb-12 leading-relaxed max-w-xl">
          Those who put on the show. Explore the complete database of every featured professional player in the league. Filter by role, team, region or compare the two of them to show who's the best of the bunch. 
        </p>
        <div class="flex flex-wrap gap-4">
            <a href="/players" class="inline-flex items-center gap-3 px-10 py-5 bg-white hover:bg-neutral-200 text-black font-black font-title text-2xl rounded transition-transform hover:translate-x-1 shadow-lg">
            Browse Players <span>→</span>
            </a>
            <a href="/compare" class="inline-flex items-center gap-2 px-10 py-5 border-2 border-neutral-700 hover:border-white text-white font-bold font-title text-2xl rounded transition-colors">
                Compare Stats
            </a>
        </div>
      </div>

      {/* HERO IMAGE */}
      <div class="order-2 relative h-[400px] lg:h-[500px] rounded-3xl overflow-hidden shadow-2xl w-full">
         <div class="absolute inset-0 bg-blue-500/20 mix-blend-overlay z-10"></div>
         <img src={PLAYER_SECTION_IMG} class="w-full h-full object-cover object-center scale-105 hover:scale-100 transition-transform duration-[1.5s] ease-out" alt="Overwatch Pros" />
         <div class="absolute inset-0 bg-gradient-to-t from-neutral-900 via-transparent to-transparent z-20 lg:hidden"></div>
      </div>

    </div>
  </section>
      
    </div>
  </section>


  {/* ==============================================
  ROW 3: THE TEAMS (Image Left / Text Right)
  ============================================== */}
  <section class="py-32 bg-neutral-950 relative overflow-hidden">
    <div class="max-w-7xl mx-auto px-4 grid grid-cols-1 lg:grid-cols-2 gap-16 items-center">
      
      {/* HERO IMAGE (Order 2 on mobile, Order 1 on desktop -> Flips it!) */}
      <div class="order-2 lg:order-1 relative h-[500px] lg:h-[600px] rounded-3xl overflow-hidden shadow-2xl">
         <img src={TEAM_SECTION_IMG} class="w-full h-full object-cover object-center scale-105" alt="OWCS Stage" />
         <div class="absolute inset-0 bg-gradient-to-t from-neutral-950 via-transparent to-transparent z-20 lg:hidden"></div>
      </div>

      {/* TEXT BLOCK (Order 1 on mobile, Order 2 on desktop) */}
      <div class="order-1 lg:order-2 lg:pl-12">
        <h2 class="text-white font-bold tracking-widest uppercase mb-4 text-sm flex items-center gap-2">
            <span class="w-8 h-px bg-white"></span> The Organizations
        </h2>
        <h3 class="text-5xl md:text-6xl font-title text-white mb-6 leading-none">Featured Teams</h3>
        <p class="text-neutral-400 text-lg mb-10 leading-relaxed max-w-xl">
          Get detailed profiles, active rosters, and match history for the organizations defining the modern era of Overwatch E-Sports.
        </p>
        <div class="flex flex-wrap gap-4">
            <a href="/teams" class="inline-flex items-center gap-3 px-8 py-4 bg-white hover:bg-neutral-200 text-black font-black font-title text-xl rounded transition-transform hover:translate-x-1">
            View Teams <span>→</span>
            </a>
             <a href="/compareTeams" class="inline-flex items-center gap-2 px-8 py-4 border-2 border-neutral-700 hover:border-white text-white font-bold font-title text-xl rounded transition-colors">
                Face-Off
            </a>
        </div>
      </div>

    </div>
  </section>
    
  </div>
</BaseLayout>

<script>
  function startVideoRotation() {
    const video = document.getElementById("hero-video");
    if (!video || typeof (video as HTMLVideoElement).play !== "function") {
      return;
    }

    const videoPlayer = video as HTMLVideoElement;

    // 1. Get the list of clips from the data attribute
    const clips = JSON.parse(videoPlayer.dataset.clips || "[]");

    if (clips.length === 0) return; // Do nothing if no clips

    let currentClipIndex = -1; // Keep track of the last clip

    function playRandomClip() {
      let nextIndex = currentClipIndex;
      // 2. Pick a new clip, but make sure it's not the same one as last time
      while (nextIndex === currentClipIndex && clips.length > 1) {
        nextIndex = Math.floor(Math.random() * clips.length);
      }
      currentClipIndex = nextIndex;

      // 3. Set the new video source and load it
      videoPlayer.src = clips[currentClipIndex];
      videoPlayer.load();

      // 4. Play the video
      const playPromise = videoPlayer.play();
      if (playPromise !== undefined) {
        playPromise.catch((error) => {
          console.warn("Browser blocked video autoplay:", error);
        });
      }
    }

    // 5. When the video ends, play a new random one
    videoPlayer.addEventListener("ended", playRandomClip);

    // 6. Play the *first* random clip on page load
    playRandomClip();
  }

  // 7. This still handles the "back button" issue
  document.addEventListener("astro:page-load", startVideoRotation);
</script>
