---
// src/pages/index.astro
export const prerender = false;

import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import LiveMatchCard from '../components/LiveMatchCard.tsx';
import FeatureSection from "../components/FeatureSection.astro";
/*import { calculateRankings } from "../lib/calcELO";
import { fetchAllSeasonMatches } from "../lib/fetchMatches";*/

/*const apiKey = import.meta.env.LIQUIPEDIA_API_KEY;
const userAgent = 'OWCS-Nexus (barcanvladi@gmail.com)';
const matches = await fetchAllSeasonMatches(apiKey, userAgent);
const { rankings } = calculateRankings(matches);
// Get Top 5 for the preview widget
const top5 = rankings.slice(0, 5);*/

const top5=[
  { name: "Team Falcons", rating: 1606, region: "Korea" },
  { name: "Crazy Raccoon", rating: 1568, region: "Korea" },
  { name: "Team Liquid", rating: 1492, region: "NA" }, // Example
  { name: "Virtus.pro", rating: 1450, region: "NA" },
  { name: "Twisted Minds", rating: 1420, region: "EMEA" }
];

const allTeams = await getCollection("teams");
const teamsByRegion = allTeams.reduce((acc, team) => {
  const region = team.data.region;
  if (!acc[region]) {
    acc[region] = [];
  }
  acc[region].push(team);
  return acc;
}, {});

// 1. Get your Cloudinary cloud name from the logo URL.
// e.g., "https://res.cloudinary.com/dm1bfprgq/image/upload/..."
const cloudName = allTeams[0].data.logo.split("/")[3];
const heroClipIDs = [
  "crazy_raccoons_clip",
  "wbg_clip",
  "vl_clip",
  "vp_clip",
  "aq_clip",
  "ntmp_clip",
  "tm_clip",
  "t1_clip",
  "tl_clip",
  "agg_clip",
  "cc_clip",
  "gk_clip",
  "ssg_clip"
];

// 2. Build the *correct* video base URL
const videoBaseUrl = `https://res.cloudinary.com/${cloudName}/video/upload/f_auto,q_auto:good,w_1280,br_1.5m/v1764360031`;

const heroClipUrls = heroClipIDs.map((id) => {
  // We'll use the format that we know works!
  return `${videoBaseUrl}/${id}.mp4`;
});

function getTeamLogo(name: string) {
  const local = allTeams.find(t => t.data.name === name);
  return local?.data.logo?.replace('/upload/', '/upload/w_64,h_64,c_pad,f_auto,q_auto/') || null;
}

const PLAYER_SECTION_IMG = "https://live.staticflickr.com/65535/53888289946_ca9b058f28_k.jpg";
const TEAM_SECTION_IMG = "https://live.staticflickr.com/65535/54692531031_150e8b42ef_k.jpg";
---

<BaseLayout title="Home">
  <div class="max-w-7xl mx-auto px-4">
    <div
      class="relative h-[600px] w-full rounded-lg overflow-hidden
             flex justify-center items-center text-center
             bg-neutral-900 mb-24 shadow-xl"
    >
      <video
        id="hero-video"
        data-clips={JSON.stringify(heroClipUrls)}
        class="absolute z-0 w-full h-full object-cover"
        autoplay
        loop
        muted
        playsinline
      >
        Your browser does not support the video tag.
      </video>

      <div class="absolute inset-0 bg-black/40 z-10"></div>

      <div class="relative z-20 p-8">
        <h1
          class="text-7xl md:text-8xl font-bold text-white font-title"
          style="text-shadow: 2px 2px 8px rgba(0,0,0,0.7);"
        >
          OWCS Nexus
        </h1>
        <p
          class="text-2xl md:text-3xl text-neutral-200 mt-2"
          style="text-shadow: 1px 1px 4px rgba(0,0,0,0.5);"
        >
          All of OWCS, right at your fingertips.
        </p>
      </div>
    </div>

     <LiveMatchCard client:load />


{/* ==============================================
      ROW 1: GLOBAL RANKINGS (Amber)
      ============================================== */}
  <FeatureSection
    title="Global Power Rankings"
    subtitle="Live Leaderboard"
    description="Data doesn't lie. Our algorithmic ELO system tracks every official match in real-time to determine the true hierarchy of the global scene."
    theme="amber"
    primaryLink={{ text: "View Standings", href: "/rankings" }}
  >
     {/* The Widget Slot */}
     <div class="bg-neutral-900/80 border border-neutral-800 rounded-2xl overflow-hidden shadow-2xl backdrop-blur-sm">
        <div class="p-4 border-b border-neutral-800 bg-neutral-950/50 flex justify-between items-center">
            <span class="text-neutral-500 font-bold text-xs uppercase">Current Top 5</span>
            <span class="text-amber-500 text-xs">‚óè Season Standings</span>
        </div>
        {top5.map((team, i) => (
           <div class="flex items-center justify-between p-4 border-b border-neutral-800/50 last:border-0 hover:bg-neutral-800/30 transition-colors">
               <div class="flex items-center gap-4">
                 <span class={`font-title text-2xl w-8 text-center ${i === 0 ? 'text-amber-500' : 'text-neutral-600'}`}>#{i + 1}</span>
                 <img src={getTeamLogo(team.name)} class="w-8 h-8 object-contain" />
                 <span class="font-bold text-lg text-white">{team.name}</span>
               </div>
               <span class="font-mono font-bold text-neutral-400">{Math.round(team.rating)}</span>
           </div>
        ))}
     </div>
  </FeatureSection>

  {/* ==============================================
      ROW 2: THE PLAYERS (Blue)
      ============================================== */}
  <FeatureSection
    title="Meet the Pros"
    subtitle="The Talent"
    description="Explore the complete database of every professional player. Filter by role, team, or region to find the next superstar."
    theme="purple"
    align="right" /* Flip layout for visual interest */
    primaryLink={{ text: "Browse Players", href: "/players" }}
    secondaryLink={{ text: "Compare Stats", href: "/compare" }}
  >
     {/* The Image Slot */}
     <div class="relative h-[500px] rounded-3xl overflow-hidden shadow-2xl border border-blue-900/30 group">
         <div class="absolute inset-0 bg-blue-500/10 mix-blend-overlay z-10"></div>
         <img src={PLAYER_SECTION_IMG} class="w-full h-full object-cover object-center scale-105 hover:scale-100 transition-transform duration-[1.5s]" />
         <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent z-20 lg:hidden"></div>
     </div>
  </FeatureSection>

  {/* ==============================================
  ROW 2.5: THE WORLD CUP (Cyan Theme)
  ============================================== */}
  <FeatureSection
    title="OWWC 2026"
    subtitle="National Pride"
    description="The world unites once again. Track national rosters, view the interactive global map, and follow the road to BlizzCon."
    theme="cyan"
    align="right"
    primaryLink={{ text: "Enter War Room", href: "/world-cup" }}
  >
     
     {/* THE VISUAL SLOT (Image + Floating Card) */}
     <div class="relative h-[500px] rounded-3xl overflow-hidden border border-cyan-500/30 shadow-[0_0_40px_-10px_rgba(6,182,212,0.3)] group">
         
         {/* Background Image */}
         <img 
           src="https://imguscdn.gamespress.com/cdn/files/BlizzardLive/2019/11/03002203-6bee7a7b-7a78-45c2-87a1-d2b00e027aaa/20191102_Carlton-Beener_Blizzcon2019_OWWC_00563.jpg?otf=y&lightbox=y&sky=6f24b15fbf6b31b65bb221503356008903da709703ef7d33c00b6fa266241593&w=1024&maxheight=4096&mode=pad&format=jpg" 
           alt="Overwatch World Cup" 
           class="w-full h-full object-cover opacity-60 group-hover:opacity-80 group-hover:scale-105 transition-all duration-1000 filter hue-rotate-15"
         />
         
         {/* Cyan Overlay */}
         <div class="absolute inset-0 bg-gradient-to-t from-cyan-950/80 via-transparent to-transparent"></div>
         
         {/* Floating "Next Event" Badge */}
         <div class="absolute bottom-6 left-6 right-6">
            <div class="bg-black/80 backdrop-blur-md border border-cyan-500/30 p-5 rounded-2xl flex items-center justify-between shadow-lg group-hover:border-cyan-400/50 transition-colors">
               <div>
                  <p class="text-xs text-cyan-400 font-bold uppercase tracking-wider mb-1 flex items-center gap-2">
                     <span class="w-2 h-2 rounded-full bg-cyan-400 animate-pulse"></span> Next Event
                  </p>
                  <p class="text-white font-title text-2xl tracking-wide">Americas Conference</p>
               </div>
               
               <div class="w-12 h-12 rounded-full bg-cyan-500/20 border border-cyan-400/50 flex items-center justify-center text-cyan-400 group-hover:bg-cyan-500 group-hover:text-black transition-all">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
               </div>
            </div>
         </div>

      </div>

  </FeatureSection>

  {/* ==============================================
      ROW 3: THE TEAMS (Emerald)
      ============================================== */}
  <FeatureSection
    title="Partner Teams"
    subtitle="The Organizations"
    description="Get detailed profiles, active rosters, and match history for the organizations defining the modern era of Overwatch Esports."
    theme="emerald"
    primaryLink={{ text: "View Teams", href: "/teams" }} 
    secondaryLink={{ text: "Face-Off", href: "/compare-teams" }}
  >
      {/* The Image Slot */}
      <div class="relative h-[500px] rounded-3xl overflow-hidden shadow-2xl border border-emerald-900/30 group">
         <div class="absolute inset-0 bg-emerald-500/10 mix-blend-overlay z-10"></div>
         <img src={TEAM_SECTION_IMG} class="w-full h-full object-cover object-center scale-105 hover:scale-100 transition-transform duration-[1.5s]" />
      </div>
  </FeatureSection>
</BaseLayout>

<script>
  function startVideoRotation() {
    const video = document.getElementById("hero-video");
    if (!video || typeof (video as HTMLVideoElement).play !== "function") {
      return;
    }

    const videoPlayer = video as HTMLVideoElement;

    // 1. Get the list of clips from the data attribute
    const clips = JSON.parse(videoPlayer.dataset.clips || "[]");

    if (clips.length === 0) return; // Do nothing if no clips

    let currentClipIndex = -1; // Keep track of the last clip

    function playRandomClip() {
      let nextIndex = currentClipIndex;
      // 2. Pick a new clip, but make sure it's not the same one as last time
      while (nextIndex === currentClipIndex && clips.length > 1) {
        nextIndex = Math.floor(Math.random() * clips.length);
      }
      currentClipIndex = nextIndex;

      // 3. Set the new video source and load it
      videoPlayer.src = clips[currentClipIndex];
      videoPlayer.load();

      // 4. Play the video
      const playPromise = videoPlayer.play();
      if (playPromise !== undefined) {
        playPromise.catch((error) => {
          console.warn("Browser blocked video autoplay:", error);
        });
      }
    }

    // 5. When the video ends, play a new random one
    videoPlayer.addEventListener("ended", playRandomClip);

    // 6. Play the *first* random clip on page load
    playRandomClip();
  }

  // 7. This still handles the "back button" issue
  document.addEventListener("astro:page-load", startVideoRotation);
</script>
