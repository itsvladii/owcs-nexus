---
// src/pages/index.astro
export const prerender = false;

import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import LiveMatchCard from "../components/homeComps/LiveMatchCard";
import FeatureSection from "../components/homeComps/FeatureSection.astro";

const top5=[
  { name: "Team Falcons", rating: 1606, region: "Korea" },
  { name: "Crazy Raccoon", rating: 1568, region: "Korea" },
  { name: "Team Liquid", rating: 1492, region: "NA" }, // Example
  { name: "Virtus.pro", rating: 1450, region: "NA" },
  { name: "Twisted Minds", rating: 1420, region: "EMEA" }
];

const allTeams = await getCollection("teams");
const teamsByRegion = allTeams.reduce((acc, team) => {
  const region = team.data.region;
  if (!acc[region]) {
    acc[region] = [];
  }
  acc[region].push(team);
  return acc;
}, {});

// 1. Get your Cloudinary cloud name from the logo URL.
// e.g., "https://res.cloudinary.com/dm1bfprgq/image/upload/..."
const cloudName = allTeams[0].data.logo.split("/")[3];
const heroClipIDs = [
  "crazy_raccoons_clip",
  "wbg_clip",
  "vl_clip",
  "vp_clip",
  "aq_clip",
  "ntmp_clip",
  "tm_clip",
  "t1_clip",
  "tl_clip",
  "agg_clip",
  "cc_clip",
  "gk_clip",
  "ssg_clip",
  "tf_clip"
];

// 2. Build the *correct* video base URL
const videoBaseUrl = `https://res.cloudinary.com/${cloudName}/video/upload/f_auto,q_auto:good,w_1280,br_1.5m/v1764453427`;

const heroClipUrls = heroClipIDs.map((id) => {
  // We'll use the format that we know works!
  return `${videoBaseUrl}/${id}.mp4`;
});

function getTeamLogo(name: string) {
  const local = allTeams.find(t => t.data.name === name);
  return local?.data.logo?.replace('/upload/', '/upload/w_64,h_64,c_pad,f_auto,q_auto/') || null;
}

const PLAYER_SECTION_IMG = "https://live.staticflickr.com/65535/54692530696_89bc1454e3_k.jpg";
const TEAM_SECTION_IMG = "https://live.staticflickr.com/65535/54694984050_06f246087e_k.jpg";

const allNews = await getCollection('news');

// Sort by Date (Newest First) and take top 3
const latestArticles = allNews
  .sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf())
  .slice(0, 3);
---

<BaseLayout title="Home">
  <div class="max-w-7xl mx-auto px-4">
    <div
      class="relative h-[600px] w-full rounded-lg overflow-hidden
             flex justify-center items-center text-center
             bg-neutral-900 mb-24 shadow-xl"
    >
      <video
        id="hero-video"
        data-clips={JSON.stringify(heroClipUrls)}
        class="absolute z-0 w-full h-full object-cover"
        autoplay
        loop
        muted
        playsinline
      >
        Your browser does not support the video tag.
      </video>

      <div class="absolute inset-0 bg-black/40 z-10"></div>

      <div class="relative z-20 p-8">
        <h1
          class="text-7xl md:text-8xl font-bold text-white font-title"
          style="text-shadow: 2px 2px 8px rgba(0,0,0,0.7);"
        >
          OWCS Nexus
        </h1>
        <p
          class="text-2xl md:text-3xl text-neutral-200 mt-2"
          style="text-shadow: 1px 1px 4px rgba(0,0,0,0.5);"
        >
          All of OWCS, right at your fingertips.
        </p>
      </div>
    </div>

     <LiveMatchCard client:load />


{/* ==============================================
      ROW 1: GLOBAL RANKINGS (Amber)
      ============================================== */}
  <FeatureSection
    title="Global Power Rankings"
    subtitle="Live Leaderboard"
    description="Data doesn't lie. Our algorithmic ELO system tracks every official match in real-time to determine the true hierarchy of the global scene."
    theme="red"
    primaryLink={{ text: "View Standings", href: "/rankings" }}
  >
     {/* The Widget Slot */}
     <div class="bg-neutral-900/80 border border-neutral-800 rounded-2xl overflow-hidden shadow-2xl backdrop-blur-sm">
        <div class="p-4 border-b border-neutral-800 bg-neutral-950/50 flex justify-between items-center">
            <span class="text-neutral-500 font-bold text-xs uppercase">Current Top 5</span>
            <span class="text-red-500 text-xs">‚óè Season Standings</span>
        </div>
        {top5.map((team, i) => (
           <div class="flex items-center justify-between p-4 border-b border-neutral-800/50 last:border-0 hover:bg-neutral-800/30 transition-colors">
               <div class="flex items-center gap-4">
                 <span class={`font-title text-2xl w-8 text-center ${i === 0 ? 'text-red-500' : 'text-neutral-600'}`}>#{i + 1}</span>
                 <img src={getTeamLogo(team.name)} class="w-8 h-8 object-contain" />
                 <span class="font-bold text-lg text-white">{team.name}</span>
               </div>
               <span class="font-mono font-bold text-neutral-400">{Math.round(team.rating)}</span>
           </div>
        ))}
     </div>
  </FeatureSection>

    {/* ==============================================
      ROW 2: OWCS TRANSFER MARKET
      ============================================== */}
  <FeatureSection
    title="TRANSFER HUB"
    subtitle="THE MOVES"
    description="Keep up with all the most recent transfers in the OWCS world, from players to coaches and analists."
    theme="deadline"
    align="left" // Text Left, Articles Right
    primaryLink={{ text: "View Transfers", href: "/transfers" }}
  >
     
     {/* THE SLOT: Vertical Article Stack */}
     <div class="relative h-[500px] rounded-3xl overflow-hidden shadow-2xl border border-blue-900/30 group">
         <div class="absolute inset-0 bg-blue-500/10 mix-blend-overlay z-10"></div>
         <img src={"https://live.staticflickr.com/65535/54692863385_f06c46e6e9_k.jpg"} class="w-full h-full object-cover object-center scale-105 hover:scale-100 transition-transform duration-[1.5s]" />
         <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent z-20 lg:hidden"></div>
     </div>

  </FeatureSection>

  {/* ==============================================
      ROW 2: THE PLAYERS (Blue)
      ============================================== */}
  <FeatureSection
    title="Meet the Pros"
    subtitle="The Talent"
    description="Explore the complete database of every professional player. Filter by role, team, or region to find the next superstar."
    theme="purple"
    align="right" /* Flip layout for visual interest */
    primaryLink={{ text: "Browse Players", href: "/players" }}
    secondaryLink={{ text: "Compare Stats", href: "/compare" }}
  >
     {/* The Image Slot */}
     <div class="relative h-[500px] rounded-3xl overflow-hidden shadow-2xl border border-blue-900/30 group">
         <div class="absolute inset-0 bg-blue-500/10 mix-blend-overlay z-10"></div>
         <img src={PLAYER_SECTION_IMG} class="w-full h-full object-cover object-center scale-105 hover:scale-100 transition-transform duration-[1.5s]" />
         <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent z-20 lg:hidden"></div>
     </div>
  </FeatureSection>

 

  {/* ==============================================
      ROW 3: THE TEAMS (Emerald)
      ============================================== */}
  <FeatureSection
    title="Partner Teams"
    subtitle="The Organizations"
    description="Get detailed profiles, active rosters, and match history for the organizations defining the modern era of Overwatch Esports."
    theme="emerald"
    primaryLink={{ text: "View Teams", href: "/teams" }} 
    secondaryLink={{ text: "Face-Off", href: "/compareTeams" }}
  >
      {/* The Image Slot */}
      <div class="relative h-[500px] rounded-3xl overflow-hidden shadow-2xl border border-emerald-900/30 group">
         <div class="absolute inset-0 bg-emerald-500/10 mix-blend-overlay z-10"></div>
         <img src={TEAM_SECTION_IMG} class="w-full h-full object-cover object-center scale-105 hover:scale-100 transition-transform duration-[1.5s]" />
      </div>
  </FeatureSection>
</BaseLayout>

<script>
  function startVideoRotation() {
    const video = document.getElementById("hero-video");
    if (!video || typeof (video as HTMLVideoElement).play !== "function") {
      return;
    }

    const videoPlayer = video as HTMLVideoElement;

    // 1. Get the list of clips from the data attribute
    const clips = JSON.parse(videoPlayer.dataset.clips || "[]");

    if (clips.length === 0) return; // Do nothing if no clips

    let currentClipIndex = -1; // Keep track of the last clip

    function playRandomClip() {
      let nextIndex = currentClipIndex;
      // 2. Pick a new clip, but make sure it's not the same one as last time
      while (nextIndex === currentClipIndex && clips.length > 1) {
        nextIndex = Math.floor(Math.random() * clips.length);
      }
      currentClipIndex = nextIndex;

      // 3. Set the new video source and load it
      videoPlayer.src = clips[currentClipIndex];
      videoPlayer.load();

      // 4. Play the video
      const playPromise = videoPlayer.play();
      if (playPromise !== undefined) {
        playPromise.catch((error) => {
          console.warn("Browser blocked video autoplay:", error);
        });
      }
    }

    // 5. When the video ends, play a new random one
    videoPlayer.addEventListener("ended", playRandomClip);

    // 6. Play the *first* random clip on page load
    playRandomClip();
  }

  // 7. This still handles the "back button" issue
  document.addEventListener("astro:page-load", startVideoRotation);
</script>
