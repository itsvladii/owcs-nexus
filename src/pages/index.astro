---
// src/pages/index.astro
export const prerender = false;

import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import LiveMatchCard from "../components/homeComps/LiveMatchCard";
import FeatureSection from "../components/homeComps/FeatureSection.astro";

// --- DATA SETUP ---

const heroClipIDs = [
  "crazy_raccoons_clip", "wbg_clip", "vl_clip", "vp_clip", "aq_clip",
  "ntmp_clip", "tm_clip", "t1_clip", "tl_clip", "agg_clip",
  "cc_clip", "gk_clip", "ssg_clip", "tf_clip"
];

// ⚡ OPTIMIZATION FIX ⚡
// 1. w_1080: Cap resolution (1080p is plenty for background)
// 2. q_auto:eco: Aggressive compression (saves bandwidth)
// 3. br_2500k: Cap bitrate to 2.5Mbps to prevent network stutter
// 4. vc_h264: Force H.264 codec (maximum hardware compatibility)
const videoBaseUrl = `https://res.cloudinary.com/dm1bfprgq/video/upload/f_mp4,vc_h264,w_1080,q_auto:eco,br_2500k/v1764453427`;

const heroClipUrls = heroClipIDs.map((id) => `${videoBaseUrl}/${id}.mp4`);

// ⚡ SERVER-SIDE PICK ⚡
// Pick the first video NOW, on the server. Don't wait for the client.
const startVideo = heroClipUrls[Math.floor(Math.random() * heroClipUrls.length)];


---

<BaseLayout title="Home" fullWidth={true}>
  
  {/* ==============================================
      1. CINEMATIC VIDEO HERO
      ============================================== */}
  <div class="relative h-screen w-full overflow-hidden bg-neutral-950 flex items-center justify-center">
      
      {/* THE ENGINE */}
      <div id="video-container" class="absolute inset-0 w-full h-full" data-clips={JSON.stringify(heroClipUrls)}>
          
          {/* PLAYER 1 (Starts Active with Server-Side Src) */}
          <video
            id="player-1"
            class="absolute inset-0 w-full h-full object-cover opacity-60 scale-105 transition-opacity duration-1000" 
            src={startVideo}
            autoplay
            muted
            playsinline
          ></video>

          {/* PLAYER 2 (Standby - Empty for now) */}
          <video
            id="player-2"
            class="absolute inset-0 w-full h-full object-cover opacity-0 scale-105 transition-opacity duration-1000" 
            muted
            playsinline
            preload="none"
          ></video>
      </div>

      {/* TECH OVERLAY (Grid) */}
      <div 
        class="absolute inset-0 z-10 opacity-20 pointer-events-none" 
        style="background-image: linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px); background-size: 40px 40px;"
      ></div>

      {/* VIGNETTE & GRADIENTS */}
      <div class="absolute inset-0 z-10 bg-[radial-gradient(circle_at_center,transparent_0%,#000000_100%)] opacity-50"></div>
      <div class="absolute inset-0 z-10 bg-gradient-to-t from-neutral-950 via-transparent to-neutral-950/50"></div>

      {/* HERO CONTENT */}
      <div class="relative z-20 text-center px-4 animate-in fade-in zoom-in duration-1000">
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-white/10 bg-white/5 backdrop-blur-md text-white/60 text-[10px] font-bold uppercase tracking-widest mb-6">
            <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
            System Online
        </div>
        <h1
          class="text-7xl md:text-9xl font-black text-white font-title tracking-tighter uppercase"
          style="text-shadow: 0 0 40px rgba(255,255,255,0.1);"
        >
          OWCS Nexus
        </h1>
        <p class="text-xl md:text-2xl text-neutral-400 mt-4 max-w-xl mx-auto font-light tracking-wide">
          All of OWCS, <span class="text-white font-bold">At your fingertips.</span>
        </p>
      </div>
<div class="absolute bottom-0 left-0 w-full z-30 bg-gradient-to-t from-neutral-950 via-neutral-950/80 to-transparent pb-12 pt-24 px-4 flex flex-col items-center">
          
          {/* Optional: 'Live' Label to tie it to the system UI */}
          <div class="mb-3 opacity-0 animate-in slide-in-from-bottom-4 fade-in duration-1000 delay-500">
             <span class="text-[10px] font-mono font-bold text-red-500 uppercase tracking-widest bg-red-500/10 px-3 py-1 rounded-full border border-red-500/20 flex items-center gap-2">
                <span class="relative flex h-2 w-2">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
                </span>
                Active Uplink
             </span>
          </div>

          {/* The Match Card - Now firmly anchored */}
          <div class="w-full max-w-5xl animate-in slide-in-from-bottom-8 fade-in duration-1000 delay-300">
             <LiveMatchCard client:load />
          </div>
      </div>
  </div>

  {/* ==============================================
      2. REST OF CONTENT (Unchanged)
      ============================================== */}
  <div class="max-w-7xl mx-auto px-4 py-24 relative z-20">

    {/* ROW 1: RANKINGS */}
    <FeatureSection
        title="Global Power Rankings"
        subtitle="Live Leaderboard"
        description="Data doesn't lie. Our algorithmic ELO system tracks every official match in real-time."
        theme="red"
        primaryLink={{ text: "View Standings", href: "/rankings" }}
    >
        <div class="relative h-[500px] rounded-3xl overflow-hidden shadow-2xl border border-white/10 group">
            <div class="absolute inset-0 bg-gradient-to-b from-transparent to-black/80 z-10"></div>
            <img src={"https://live.staticflickr.com/65535/54957178670_8abc8fb8eb_k.jpg"} class="w-full h-full object-cover object-center scale-105 group-hover:scale-100 transition-transform duration-[1.5s]" />
        </div>
    </FeatureSection>

    {/* ROW 2: TRANSFERS */}
    <FeatureSection
        title="Transfer Wire"
        subtitle="Roster Moves"
        description="Track every signing, release, and rumor in the ecosystem."
        theme="blue"
        align="right"
        primaryLink={{ text: "View Transfers", href: "/transfers" }}
    >
        <div class="relative h-[500px] rounded-3xl overflow-hidden shadow-2xl border border-white/10 group">
            <div class="absolute inset-0 bg-gradient-to-b from-transparent to-black/80 z-10"></div>
            <img src={"https://live.staticflickr.com/65535/54692863385_f06c46e6e9_k.jpg"} class="w-full h-full object-cover object-center scale-105 group-hover:scale-100 transition-transform duration-[1.5s]" />
        </div>
    </FeatureSection>

    {/* ROW 3: STOCK MARKET */}
    <FeatureSection
        title="Watch Smarter.<br/><span class='text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-400'>Trade Better.*</span>"
        subtitle="Nexus Markets"
        description="Don't just cheer for your team's victory: own a piece of it."
        theme="market"
        align="left"
        primaryLink={{ text: "Open Exchange", href: "/portfolio" }}
        disclaimer="*Fantasy simulation. No real money involved."
    >
        <div class="relative group">
            <div class="absolute -inset-1 bg-gradient-to-r from-emerald-500 to-cyan-500 rounded-2xl blur opacity-20 group-hover:opacity-40 transition duration-1000"></div>
            <div class="relative bg-neutral-900 border border-white/10 rounded-2xl p-6 shadow-2xl overflow-hidden">
                <div class="flex justify-between items-center mb-6 border-b border-white/5 pb-4">
                    <div class="flex items-center gap-3">
                        <img src="https://res.cloudinary.com/dm1bfprgq/image/upload/v1762898092/tm_logo_xx1e3y.png" class="w-8 h-8 object-contain" />
                        <div>
                            <div class="font-bold text-white">Twisted Minds</div>
                            <div class="text-xs text-neutral-500">EMEA</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-mono font-bold text-emerald-400">$161.75</div>
                        <div class="text-xs text-emerald-500/80 bg-emerald-500/10 px-2 py-0.5 rounded">▲ TRENDING</div>
                    </div>
                </div>
                <div class="h-32 w-full bg-gradient-to-b from-emerald-500/10 to-transparent flex items-end mb-6 relative overflow-hidden rounded-lg border border-emerald-500/10">
                    <svg class="absolute bottom-0 w-full h-full text-emerald-500" preserveAspectRatio="none" viewBox="0 0 100 100">
                        <path d="M0 80 Q 20 90 40 60 T 80 40 L 100 20 V 100 H 0 Z" fill="currentColor" opacity="0.2" />
                        <path d="M0 80 Q 20 90 40 60 T 80 40 L 100 20" fill="none" stroke="currentColor" stroke-width="2" />
                    </svg>
                </div>
                <div class="grid grid-cols-2 gap-4 opacity-50 pointer-events-none">
                    <div class="bg-emerald-500/20 border border-emerald-500/50 text-emerald-400 text-center py-3 rounded-lg font-bold uppercase text-sm">Buy</div>
                    <div class="bg-neutral-800 border border-white/10 text-neutral-500 text-center py-3 rounded-lg font-bold uppercase text-sm">Sell</div>
                </div>
            </div>
        </div>
    </FeatureSection>

  </div>
</BaseLayout>

{/* 3. OPTIMIZED ENGINE SCRIPT */}
<script>
  function initVideoEngine() {
    const container = document.getElementById("video-container");
    const p1 = document.getElementById("player-1") as HTMLVideoElement;
    const p2 = document.getElementById("player-2") as HTMLVideoElement;
    
    if (!container || !p1 || !p2) return;

    // Load clips list
    const clips = JSON.parse(container.dataset.clips || "[]");
    if (clips.length === 0) return;

    // Detect which video was pre-rendered on the server
    // (This is the video src already in the DOM)
    let activePlayer = p1;
    let standbyPlayer = p2;
    
    // Find current index based on the src that Astro rendered
    let currentClipIdx = clips.findIndex(c => c === p1.src || p1.src.endsWith(c));
    if (currentClipIdx === -1) currentClipIdx = 0; // Fallback

    // Wait a few seconds before loading the NEXT video to let the page settle
    setTimeout(() => {
        prepareNextClip();
    }, 3000); 

    function prepareNextClip() {
        let nextIdx = currentClipIdx;
        while (nextIdx === currentClipIdx && clips.length > 1) {
            nextIdx = Math.floor(Math.random() * clips.length);
        }
        
        // Load the standby player
        standbyPlayer.src = clips[nextIdx];
        standbyPlayer.load(); 
        currentClipIdx = nextIdx;
    }

    function switchPlayer() {
        standbyPlayer.play().then(() => {
            // Swap Opacity (Use 0.6 to match your design)
            standbyPlayer.style.opacity = "0.6";
            activePlayer.style.opacity = "0";

            // Swap roles
            const temp = activePlayer;
            activePlayer = standbyPlayer;
            standbyPlayer = temp;

            // Prepare next clip after transition
            setTimeout(() => {
                standbyPlayer.pause();
                prepareNextClip();
            }, 1000); 

        }).catch(e => console.log("Playback failed:", e));
    }

    p1.onended = () => { if (activePlayer === p1) switchPlayer(); };
    p2.onended = () => { if (activePlayer === p2) switchPlayer(); };
  }

  document.addEventListener("astro:page-load", initVideoEngine);
</script>